# Handover — 6 February 2026

## 1  Summary of Today's Session

Three production bugs were identified and fixed, a comprehensive graph-quality
audit was performed, architecture documentation was updated, the deploy
pipeline was hardened, and Route 4 synthesis was optimized (39% shorter, 20%
faster with gpt-4.1).

### Commits Pushed to `origin/main`

| SHA        | Message |
|------------|---------|
| `15f59e1f` | fix: route traffic to new revisions on deploy + remove debug instrumentation |
| `d31142d0` | fix: ensure language spans propagate for all docs |
| `e815c092` | docs: update architecture design with Feb 6 fixes and graph audit |
| `341d0a09` | feat: add prompt_variant and synthesis_model override to Route 4 pipeline |

---

## 2  What Was Fixed

### 2.1  Deploy Traffic Routing (`15f59e1f`)

**Problem:** Azure Container Apps multi-revision mode assigned 0 % traffic to
newly deployed revisions, so live requests kept hitting old code.

**Fix (`.github/workflows/deploy.yml`):** After `azd deploy`, the workflow now
runs `az containerapp ingress traffic set … --revision-weight <new>=100` for
both `graphrag-api` and `graphrag-worker` container apps.

**Status:** ✅ Deployed & verified. 19/19 benchmark queries pass; 977 sentence-
level citations (`[Na]`) observed.

### 2.2  Language Spans Propagation — 3 Bugs (`d31142d0`)

File: `src/worker/services/document_intelligence_service.py`

| # | Bug | Fix |
|---|-----|-----|
| 1 | `_select_model()` filename heuristic matched "invoice" in URL → routed `contoso_lifts_invoice` to `prebuilt-invoice`, which does **not** support the `LANGUAGES` add-on | Removed heuristic. All docs now use `prebuilt-layout` with `LANGUAGES` add-on |
| 2 | `_build_section_aware_documents()` gated `languages` on `section_idx == 0 AND part == "direct"`. `purchase_contract` section 0 had **no** direct content (only children) | Changed gate to `len(docs) == 0` — attaches to whichever unit is emitted first |
| 3 | Page-based fallback path never included `languages` in unit metadata | Added `_extract_languages()` + `_extract_barcodes()` with attachment to first page unit |

**Status:** ✅ Committed & pushed. **Requires re-index to take effect** (see
TODO below).

### 2.3  Architecture Design Doc (`e815c092`)

Updated `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md`:

- Added Feb 6 update header with all fixes and graph audit findings.
- Updated `_select_model` documentation (heuristic removed, LANGUAGES warning).
- New Section 22.6 — Deployment traffic routing fix.
- New Section 22.7 — Language spans propagation fix details.
- Updated indexing script section with re-index requirement.
- Added `language_spans` to Document node in graph schema.
- Renumbered remaining sections 22.8–22.11.

---

## 3  Graph Completeness Audit (`test-5pdfs-v2-fix2`)

A full audit of the Neo4j graph for group `test-5pdfs-v2-fix2` revealed
**critical pre-existing issues** (all from the original indexing run, not
caused by today's changes):

| Check | Expected | Actual | Impact |
|-------|----------|--------|--------|
| `PART_OF` edges (TextChunk → Document) | 17 | **0** | Chunks de-duplication & provenance broken |
| Section `embedding_v2` | 12 non-null | **0** | Route 3 section retrieval degraded |
| KeyValue `embedding_v2` | 40 non-null | **0** | Route 4 KVP retrieval broken |
| GDS `community_id` | >0 on entities | **0** on all | Community detection not run |
| GDS `pagerank` | >0 on entities | **0** on all | PageRank not run |
| Entity KNN `SEMANTICALLY_SIMILAR` | >0 | **0** | Only KVP↔KVP edges (540) exist |
| Orphan Sections (no `HAS_SECTION`) | 0 | **3** | Unreachable sections |
| Language spans on Documents | 5/5 | **3/5** | 2 docs missing (fixed by bugs above) |

**All issues are resolved by a single re-index** with the current codebase
(post `d31142d0`).

---

## 4  Route 4 Synthesis Optimization (`341d0a09`)

**Problem:** User reported Route 4 synthesis output was unnecessarily long,
increasing response time.

**Investigation:** Prompt engineering with 4 variants (v0, v1_concise, v2_adaptive,
v3_budget) all failed — gpt-5.1 ignores word limits and formatting constraints.

**Solution:** Added `synthesis_model` parameter to override the synthesis LLM
at request level. Implemented through full API chain:

- `HybridQueryRequest` → orchestrator → route handlers → synthesis
- Model override creates temporary LLM client via `LLMService._create_llm_client()`
- Test script supports `--synthesis-model` and `--variants` flags

**Results (gpt-4.1 vs gpt-5.1 baseline across 7 queries):**

| Query | gpt-5.1 (chars) | gpt-4.1 (chars) | Reduction | gpt-5.1 (time) | gpt-4.1 (time) | Speedup |
|-------|-----------------|-----------------|-----------|----------------|----------------|----------|
| Q-D1  | 4,647 | 3,852 | **-17%** | 32.5s | 28.9s | **-11%** |
| Q-D3  | 18,438 | 8,060 | **-56%** | 64.4s | 45.9s | **-29%** |
| Q-D5  | 5,735 | 4,298 | **-25%** | 34.5s | 40.5s | +17% |
| Q-D9  | 7,852 | 5,806 | **-26%** | 35.2s | 27.4s | **-22%** |
| Q-D10 | 13,359 | 6,339 | **-53%** | 40.0s | 21.9s | **-45%** |
| Q-DR1 | 6,910 | 4,779 | **-31%** | 44.1s | 31.6s | **-28%** |
| Q-DR5 | 12,555 | 8,982 | **-28%** | 64.6s | 56.7s | **-12%** |
| **Avg** | **9,928** | **6,017** | **-39%** | **45.0s** | **36.1s** | **-20%** |

**Status:** ✅ Committed & pushed. **Quality validation needed** (see TODO 7.3).

**Untracked files:** Multiple `bench_prompt_variants_*.json` (A/B test results)

---

## 5  Infrastructure & Credentials

| Resource | Value |
|----------|-------|
| **Neo4j AuraDB** | `neo4j+s://a86dcf63.databases.neo4j.io` |
| Neo4j user / password | `neo4j` / `uvRJoWeYwAu7ouvN25427WjGnU37oMWaKN_XMN4ySKI` |
| **API endpoint** | `https://graphrag-api.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/query` |
| Azure AD scope | `api://b68b6881-80ba-4cec-b9dd-bd2232ec8817/.default` |
| Container registry | `graphragacr12153.azurecr.io` |
| DI model | `prebuilt-layout` + `LANGUAGES` add-on (all docs) |
| Deploy workflow | `.github/workflows/deploy.yml` (fixed — auto-routes traffic) |
| Test group | `test-5pdfs-v2-fix2` (5 PDFs, 17 TextChunks) |

---

## 6  Docker / Disk Status (post-cleanup)

| Item | Size | Reclaimable |
|------|------|-------------|
| Images (3 active) | 3.72 GB | 0 |
| Containers (3 running) | 906 MB | 0 |
| Local Volumes (3) | 550 MB | 0 |
| Build Cache (9) | 1.71 GB | 0 |
| **Root disk free** | **14 GB** of 119 GB (89% used) | — |

**Cleanup Summary:**
- Freed ~7.4 GB total (Docker 3.6 GB + /tmp 749 MB + ~/.cache 6.0 GB + logs 624 MB)
- /tmp: 749 MB → 564 KB
- ~/.cache: 6.0 GB → 4 KB
- /var/log: 2.2 GB → 1.6 GB
- Journal logs: vacuumed to 100 MB limit

Running containers: `neo4j-test` (local Neo4j), `generative-ai-app-*` (Azure ML
studio), `c3-progenitor` (Azure ML capability).

---

## 7  TODO — Next Steps

### 7.1  Re-index `test-5pdfs-v2-fix2` ⚡ HIGH PRIORITY

The language-span fix (`d31142d0`) and all graph-quality issues require a
re-index:

```bash
# 1. Deploy latest code to Azure Container Apps
#    (GitHub Actions deploy.yml will do this automatically on push to main,
#     which was already done — verify the revision is active)

# 2. Run re-index script
python scripts/index_4_new_groups_v2.py --group test-5pdfs-v2-fix2

# 3. Verify in Neo4j:
#    - 5/5 Documents have language_spans
#    - 17 PART_OF edges exist
#    - Sections have embedding_v2
#    - KeyValues have embedding_v2
#    - Entities have community_id > 0 and pagerank > 0
#    - SEMANTICALLY_SIMILAR edges exist between Entities
#    - 0 orphan Sections
```

### 7.2  Post-Re-index Benchmark

Run the Route 3 sentence-citation benchmark to confirm sentence-level
citation coverage improves (current: 34.9 % ratio with 977 `[Na]` across
19 queries). With all 5 docs having language_spans, coverage should increase.

### 7.3  Validate gpt-4.1 Synthesis Quality ⚡ NEXT STEP

**Critical:** The 39% length reduction and 20% speed improvement from gpt-4.1
is impressive, but we need to validate that **analytical quality** is preserved.

Route 4 synthesis performs deep reasoning:
- Cross-document comparisons
- Logical connections between evidence
- Multi-step analytical chains

**Required Tests:**

1. **Manual Quality Review** (sample 3-5 queries):
   - Compare gpt-5.1 vs gpt-4.1 responses side-by-side
   - Verify gpt-4.1 preserves key comparisons and connections
   - Check if shorter length sacrifices important insights
   - Evaluate citation accuracy (both cite same evidence?)

2. **Ground Truth Accuracy** (if available):
   - Run gpt-4.1 responses through existing accuracy metrics
   - Compare contain/F1 scores vs gpt-5.1 baseline

3. **User Acceptance**:
   - Test with actual user queries
   - Validate that conciseness improves rather than degrades UX

**Decision Point:**
- ✅ If quality tests pass → Make gpt-4.1 the default (`HYBRID_SYNTHESIS_MODEL="gpt-4.1"` in config)
- ⚠️ If quality degrades → Consider hybrid approach (use gpt-4.1 for simple queries, gpt-5.1 for complex)
- ❌ If unacceptable → Revert to gpt-5.1 and investigate other optimization paths

### 7.4  Address gpt-4.1 Rate Limits (if adopting as default)

Current gpt-4.1 deployment (DataZoneStandard, 300K TPM) hit 429 errors during
testing because both decomposition (Stage 4.1) and synthesis (Stage 4.4) use
gpt-4.1 concurrently.

**Options:**
1. **Create separate gpt-4.1 deployment for synthesis** (isolates quota)
2. **Increase gpt-4.1 capacity** beyond 300K TPM
3. **Switch decomposition to different model** (e.g., gpt-4o-mini for speed)

### 7.5  Disk Space Monitoring

Root disk is at 89 % (14 GB free of 119 GB) after cleanup. Watch for growth from:
- Docker build cache (rebuilds)
- Benchmark result files (consider archiving old `bench_*.txt` / `bench_*.json`)
- Neo4j local volumes
- /var/log (monitor and vacuum journals periodically)
- ~/.cache (can be safely cleaned when needed)

### 7.6  Production Hardening (Lower Priority)

- Add health-check / smoke-test step to deploy workflow.
- Consider single-revision mode for Azure Container Apps to avoid the
  traffic-routing issue from recurring.
- Add monitoring for sentence-citation ratio as a quality gate.
- Archive old benchmark files (`bench_*.json`, `bench_*.txt`) to save disk space

---

*Generated 2026-02-06. Refer to `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md`
for full system design documentation.*
