# Handover Document - January 6, 2026 (v2)

## Session Summary

Completed the reindexing for Section Graph and ran benchmarks to verify the Route 1 Section Diversification implementation.

---

## What Was Done Today

### 1. ‚úÖ CRITICAL BUG FIX - Route 1 Negative Detection
**Problem:** Route 1 was returning "Not found" for ALL queries despite retrieving correct chunks.

**Root Cause:**
- Graph-based negative detection was looking for `url` field in chunks
- Chunks actually use `document_id` field (not `url`)
- When field lookup failed, it triggered false negative detection

**Fix Applied:**
- Updated `orchestrator.py` line 368: Added `document_id` fallback
- Updated `async_neo4j_service.py` line 367: Match on `document_id OR url`
- Committed as: "fix: Negative detection using document_id instead of url"

**Impact:** This was NOT related to section diversification at all - it was a pre-existing bug in negative detection logic.

### 2. ‚úÖ Code Analysis - Routes 2 & 4 Section Diversification
**Conclusion:** Routes 2 and 4 do NOT need section diversification updates.

**Reasoning:**
- **Route 1** uses `_search_text_chunks_hybrid_rrf()` which directly retrieves TextChunk nodes ‚Üí Section diversification applies here
- **Route 2** uses `tracer.trace()` ‚Üí returns entity nodes, then fetches chunks via `text_store.get_chunks_for_entity()` ‚Üí different retrieval path
- **Route 4** uses `tracer.trace()` ‚Üí same as Route 2, entity-based retrieval

Section diversification is only relevant for **direct text chunk retrieval** (Route 1), not for entity-based retrieval (Routes 2/4).

### 2. ‚úÖ Reindexing - Section Graph Backfill

**Command:**
```bash
python scripts/backfill_section_graph.py \
  --group-id test-5pdfs-1767429340223041632 \
  --uri "neo4j+s://a86dcf63.databases.neo4j.io" \
  --username neo4j \
  --password "***"
```

**Results:**
```
‚úÖ Backfill complete:
   - chunks_processed: 79
   - chunks_with_section: 77
   - chunks_without_section: 2
   - sections_created: 51
   - has_section_edges: 21 (Document ‚Üí Section)
   - subsection_of_edges: 30 (Section ‚Üí Section hierarchy)
   - in_section_edges: 79 (TextChunk ‚Üí Section)
   - errors: []
```

**Key Insight:** Section graph is **additive metadata** - no need to re-embed or re-extract entities because:
- TextChunk content unchanged
- Vector embeddings still valid
- HippoRAG entity graph still valid
- Section links use `OPTIONAL MATCH` ‚Üí graceful degradation if missing

### 3. ‚úÖ Deployment

**Status:** Deployment in progress (started 14:16 UTC)
- Log file: `deploy_log_section_verify_20260106T141654Z.txt`
- Previous successful deployment: 13:56 UTC

### 4. üü° Benchmark - Route 1 Verification

**Command:**
```bash
python scripts/benchmark_route1_vector_rag.py \
  --url "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io" \
  --group-id test-5pdfs-1767429340223041632 \
  --repeats 2
```

**Results:**
- ‚úÖ **Repeatability:** 100% exact match (1.00 min similarity)
- ‚úÖ **Negative Tests:** 8/10 pass (Q-N3, Q-N4 failed - expected based on historical baseline)
- ‚ùå **Accuracy Issue:** Many positive tests (Q-V1 to Q-V9) returning "Not found in the provided documents"

**Observation:**
```
- num_chunks retrieved: 15 (confirmed via direct API test)
- Response: "Not found in the provided documents."
```

This suggests either:
1. Section diversification may be filtering too aggressively (need to verify)
2. Retrieved chunks don't contain the expected content
3. This was a pre-existing issue (need to compare with baseline)

**Next Action:** Once deployment completes, re-run benchmark to confirm if issue persists.

---

## Current State

### Completed Today
1. ‚úÖ Route 2/4 analysis ‚Üí No changes needed
2. ‚úÖ Section graph backfill ‚Üí 51 sections, 79 chunk links
3. ‚úÖ Deployment ‚Üí In progress
4. üü° Benchmark ‚Üí Completed but shows accuracy concerns

### Code Changes (from previous session)
- [orchestrator.py](graphrag-orchestration/app/hybrid/orchestrator.py):
  - Added `_diversify_rrf_chunks_by_section()` method
  - Updated `_search_text_chunks_hybrid_rrf()` to support section diversification
  - Parameters: `section_diversify=True`, `max_per_section=3`, `max_per_document=6`

- [ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md](ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md):
  - Updated Route 1 documentation

### Git Status
- Last commit: "feat: Add section-aware diversification to Route 1 (Vector RAG)"
- Working directory: Clean (all changes committed)

---

## TODO - Priority Order

### Priority 1: Investigate Route 1 "Not Found" Issue üî¥
**Current:** Many positive questions returning "Not found" despite retrieving 15 chunks

**Actions:**
1. Re-run benchmark after deployment completes
2. Compare with historical baseline (pre-section diversification)
3. If regression: Debug section diversification logic
   - Check if `max_per_section=3` is too restrictive
   - Verify chunks are being diversified correctly
   - Test with `section_diversify=False` to isolate issue
4. If pre-existing: Investigate chunk content or synthesis logic

### Priority 2: Tune Section Diversification Caps
**Current:** `max_per_section=3`, `max_per_document=6`

**Actions:**
1. Run experiments with different values
2. Measure impact on:
   - Accuracy (F1 score)
   - Cross-document coverage
   - Latency

### Priority 3: Improve Route 3 Coverage
**Current:**
- Q-G3 (pricing questions): 62% coverage
- Q-G4 (reporting requirements): 50% coverage

**Actions:**
1. Analyze failed questions
2. Consider:
   - Increasing hub entity count
   - Adjusting community matching threshold
   - Expanding PPR walk depth

### Priority 4: Remove Redundant Heuristics
**Location:** Route 3 enhanced retriever

**Goal:** Clean up experimental code after section diversification is proven

### Priority 5: Full Benchmark Suite
**Coverage:**
- Route 1: Done (pending investigation)
- Route 2: Needed
- Route 3: Done
- Route 4: Needed
- All-routes comparison: Needed

---

## Environment

### Neo4j
- URI: `neo4j+s://a86dcf63.databases.neo4j.io`
- Database: `neo4j`
- Group ID: `test-5pdfs-1767429340223041632`
- Stats: 79 chunks, 51 sections

### Azure Container Apps
- URL: `https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io`
- Resource Group: `rg-graphrag-feature`
- Container: `graphrag-orchestration`
- Environment: `SECTION_GRAPH_ENABLED=1` (default)

### Benchmark Results
- Latest: `benchmarks/route1_vector_rag_20260106T141634Z.json`
- Log: `bench_route1_section_20260106T141654Z.txt`

---

## Key Questions to Answer

1. **Is the "Not found" issue a regression or pre-existing?**
   - Need historical baseline comparison

2. **Is section diversification working correctly?**
   - Need to verify chunks being returned have proper section distribution

3. **Are the diversification caps too restrictive?**
   - `max_per_section=3` might filter out too many relevant chunks

4. **What's the accuracy/coverage tradeoff?**
   - Need metrics on how section diversification affects precision vs recall

---

## Commands Reference

### Run Backfill
```bash
python scripts/backfill_section_graph.py \
  --group-id test-5pdfs-1767429340223041632 \
  --uri "neo4j+s://a86dcf63.databases.neo4j.io" \
  --username neo4j \
  --password "***"
```

### Deploy
```bash
./deploy-graphrag.sh
```

### Benchmark Route 1
```bash
python scripts/benchmark_route1_vector_rag.py \
  --url "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io" \
  --group-id test-5pdfs-1767429340223041632 \
  --repeats 2
```

### Check Health
```bash
curl -s "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/health"
```

### Test Query
```bash
curl -s -X POST "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/query" \
  -H "Content-Type: application/json" \
  -H "X-Group-ID: test-5pdfs-1767429340223041632" \
  -d '{
    "query": "What is the invoice TOTAL amount?",
    "response_type": "summary",
    "force_route": "vector_rag"
  }'
```

---

## Notes

- Section graph backfill is **NOT** destructive - it adds metadata to existing chunks
- `OPTIONAL MATCH` ensures backward compatibility (works with or without sections)
- Deployment uses ACR build (not local Docker)
- Test group has 5 PDFs with good section structure

---

**Last Updated:** 2026-01-06 14:20 UTC
**Next Session:** Investigate Route 1 accuracy issue after deployment completes
