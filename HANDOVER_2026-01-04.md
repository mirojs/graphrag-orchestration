# Handover Document - January 4, 2026

## Current Status: ROOT CAUSE IDENTIFIED - FIX READY TO DEPLOY

### What Happened Today

**Problem**: After implementing community validation in Route 3 (commits 80f4cc7-c74a0b5), ALL queries started failing with "No communities found" even for groups with indexed data.

**Symptom**: 
- Before: Route 3 working (7/10 successful, 84.4/100 score)
- After validation: 0/10 successful (100% failure rate)
- Both entity search queries returning 0 entities for groups with 474 entities

**Root Cause Found** âœ“:
The entity label is **mismatched** between different parts of the codebase:
- **GraphRAG v3 API** uses label: `Entity` (no underscores)
- **Community matcher** was querying: `__Entity__` (double underscores)
- Result: 0 entities found even though 474 entities exist

### Verification Done

1. **Confirmed entities exist**: 
   ```bash
   curl -s -H "X-Group-ID: test-5pdfs-1767429340223041632" \
     "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/graphrag/v3/stats/test-5pdfs-1767429340223041632"
   ```
   Result: `"entities": 474` âœ“

2. **Confirmed label mismatch**: Examined [graphrag-orchestration/app/v3/services/neo4j_store.py](graphrag-orchestration/app/v3/services/neo4j_store.py) line 1043:
   ```python
   query = "MATCH (e:Entity {group_id: $group_id}) RETURN count(e) as count"
   ```
   vs [graphrag-orchestration/app/hybrid/pipeline/community_matcher.py](graphrag-orchestration/app/hybrid/pipeline/community_matcher.py) line 293:
   ```python
   MATCH (e:`__Entity__`)  # WRONG LABEL!
   ```

3. **Confirmed AsyncNeo4jService is connected**: Logs show `async_neo4j_connected` before queries execute âœ“

4. **Confirmed group_id is correct**: Debug logs show `group_id_param="test-5pdfs-1767429340223041632"` âœ“

### The Fix (NOT YET DEPLOYED)

**File**: [graphrag-orchestration/app/hybrid/pipeline/community_matcher.py](graphrag-orchestration/app/hybrid/pipeline/community_matcher.py)

**Change 1** - Keyword search query (around line 264):
```python
# BEFORE (WRONG):
MATCH (e:`__Entity__`)

# AFTER (CORRECT):
MATCH (e:Entity)
```

**Change 2** - Fallback query (around line 293):
```python
# BEFORE (WRONG):
fallback_query = """
MATCH (e:`__Entity__`)
WHERE e.group_id = $group_id

# AFTER (CORRECT):
fallback_query = """
MATCH (e:Entity)
WHERE e.group_id = $group_id
```

### Test Groups Status

| Group ID | Entities | Communities | Status | Notes |
|----------|----------|-------------|---------|-------|
| `test-5pdfs-1767429340223041632` | 474 | 0 | Ready for testing | Has 961 MENTIONS edges |
| `test-5pdfs-nlp-1767461862` | 0 | 0 | Empty | No data indexed |

**Important**: Group `test-5pdfs-1767429340223041632` has:
- âœ“ 474 entities
- âœ“ 576 relationships  
- âœ“ 79 text chunks
- âœ“ 5 documents
- âœ— 0 communities (GraphRAG community detection not run)

This means the community matcher will use the **dynamic/fallback approach** (entity-based matching) rather than pre-computed communities.

### Last Test File Configuration

```bash
cat /afh/projects/graphrag-orchestration/last_test_group_id.txt
# test-5pdfs-1767429340223041632
```

### Deployment Info

**Container App**: `graphrag-orchestration`  
**Resource Group**: `rg-graphrag-feature`  
**Region**: `swedencentral`  
**FQDN**: `graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io`

**Last restart**: 2026-01-04 18:50:02 UTC

---

## TO-DO List (Priority Order)

### ðŸ”´ CRITICAL - Fix Entity Label Mismatch

1. **Apply the fix to community_matcher.py**:
   ```bash
   # Change both occurrences of `__Entity__` to `Entity`
   # Lines ~264 and ~293
   ```

2. **Deploy the fix**:
   ```bash
   cd /afh/projects/graphrag-orchestration
   ./deploy-graphrag.sh
   ```

3. **Test with correct group**:
   ```bash
   # Test Route 3 with force_route
   curl -s -X POST "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/query" \
     -H "Content-Type: application/json" \
     -H "X-Group-ID: test-5pdfs-1767429340223041632" \
     -d '{"query": "What themes emerge from the documents?", "force_route": "global_search"}' \
     | jq '{route: .route_used, citations: (.citations | length)}'
   ```

4. **Verify logs show entities found**:
   ```bash
   az containerapp logs show -n graphrag-orchestration -g rg-graphrag-feature --tail 50 2>/dev/null \
     | grep -E "fallback_top_entities_found|dynamic_community_entity_search"
   ```
   Should show: `entities_found > 0` instead of `entities_found=0`

5. **Run full benchmark**:
   ```bash
   cd /afh/projects/graphrag-orchestration
   python test_pos_neg_questions_existing_data.py
   ```
   Expected: Should restore 7/10 or better success rate

### ðŸŸ¡ MEDIUM - Router Issues

**Observation**: The router is scoring all queries as `"complexity": "0.00"`, causing everything to go to Route 1 instead of Route 3.

```json
{
  "route": "vector_rag",
  "complexity": "0.00",
  "ambiguity": "0.00",
  "combined": "0.00"
}
```

**Investigation needed**:
- Check if LLM scoring endpoint is failing silently
- Check router prompt/scoring logic in [graphrag-orchestration/app/hybrid/pipeline/router.py](graphrag-orchestration/app/hybrid/pipeline/router.py)
- Test with explicit thematic queries that should score higher

**Workaround**: Use `"force_route": "global_search"` to test Route 3 directly

### ðŸŸ¡ MEDIUM - Vector Search Returns 0 Results

Even for group `test-5pdfs-1767429340223041632` which has 79 text chunks, vector search returns:
```json
{
  "num_results": 0,
  "candidate_k": 1250,
  "vector_k": 25
}
```

**Investigation needed**:
- Check if chunk embeddings are indexed properly
- Verify vector index exists and is using correct label
- Check if there's another label mismatch (e.g., `__Chunk__` vs `Chunk`)

### ðŸŸ¢ LOW - Standardize Entity Labels Across Codebase

**Context**: The codebase has inconsistent entity label usage:
- GraphRAG v3 API: `Entity`
- LlamaIndex PropertyGraphStore: `__Entity__`
- AsyncNeo4jService queries: Mix of both

**Action**:
1. Audit all Neo4j queries for entity label usage:
   ```bash
   cd /afh/projects/graphrag-orchestration
   rg "__Entity__|:Entity" --type py -g "*.py" | grep "MATCH"
   ```

2. Decide on standard (recommend: `Entity` without underscores)

3. Update all queries to use consistent label

4. Document the decision in architecture docs

### ðŸŸ¢ LOW - Community Generation

The test group has 0 communities because GraphRAG community detection wasn't run. This is OK (the dynamic/fallback approach handles it), but for optimal performance:

1. **Check if community detection is enabled** in the indexing pipeline
2. **Run community detection** on test group if needed:
   ```bash
   # Check if this endpoint exists
   curl -X POST "https://graphrag-orchestration.../graphrag/v3/communities" \
     -H "X-Group-ID: test-5pdfs-1767429340223041632"
   ```

---

## Working Components âœ…

1. **EnhancedGraphRetriever**: Uses MENTIONS edges for citations - working correctly
2. **AsyncNeo4jService**: Connection established, queries execute (label issue aside)
3. **Fail-fast architecture**: Working as intended - immediately reports errors instead of silent fallbacks
4. **Multi-tenancy**: group_id filtering and isolation working
5. **HippoRAG integration**: Initialized correctly per group
6. **Pipeline caching**: Working (`_pipeline_cache` by group_id)

## Known Broken âŒ

1. **CommunityMatcher validation**: Label mismatch causing 0 entities (FIX READY)
2. **Router scoring**: Always returns 0.00 for complexity/ambiguity
3. **Route 1 vector search**: Returns 0 results for queries that should match

---

## Debug Commands Reference

### Check Container Status
```bash
az containerapp list -g rg-graphrag-feature --query "[].{name:name, status:properties.runningStatus}" -o table
```

### Get Logs (Last 100 lines)
```bash
az containerapp logs show -n graphrag-orchestration -g rg-graphrag-feature --tail 100 2>/dev/null
```

### Test Query with Route Forcing
```bash
curl -s -X POST "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/query" \
  -H "Content-Type: application/json" \
  -H "X-Group-ID: test-5pdfs-1767429340223041632" \
  -d '{"query": "What are the main themes?", "force_route": "global_search"}' | jq '.'
```

### Check Group Stats
```bash
curl -s -H "X-Group-ID: test-5pdfs-1767429340223041632" \
  "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/graphrag/v3/stats/test-5pdfs-1767429340223041632" \
  | jq '.'
```

### Restart Container
```bash
az containerapp revision restart -n graphrag-orchestration -g rg-graphrag-feature
```

---

## Git Status

**Current Branch**: (check with `git branch`)

**Uncommitted Changes**: 
- [graphrag-orchestration/app/hybrid/pipeline/community_matcher.py](graphrag-orchestration/app/hybrid/pipeline/community_matcher.py) - Debug logging added (lines 303-310)
- Entity label fix NOT YET APPLIED

**Recent Commits**:
- c74a0b5: Community validation (broke everything)
- 05b7217: Syntax fix for community validation
- 81097fc: Neo4j service pass-through
- 80f4cc7: Initial community validation
- a62323f: importance_score fix (LAST KNOWN WORKING)

**Recommendation**: After fix is verified, create a commit like:
```bash
git add graphrag-orchestration/app/hybrid/pipeline/community_matcher.py
git commit -m "fix: Use correct Entity label in community matcher

- Changed __Entity__ to Entity in both keyword search and fallback queries
- Fixes 100% failure rate in Route 3
- Matches label used by GraphRAG v3 API (neo4j_store.py)
"
```

---

## Context for Next Session

**What we were doing**: Debugging why Route 3 community validation was finding 0 entities

**Key insight**: The label mismatch was discovered by comparing how the stats endpoint counts entities (`Entity`) vs how community_matcher queries entities (`__Entity__`)

**Next step**: Apply the 2-line fix and deploy to verify it resolves the issue

**Expected outcome**: Route 3 should start working again with 7/10+ success rate once the label fix is deployed

---

## Questions to Consider

1. **Why the label inconsistency?**
   - LlamaIndex PropertyGraphStore uses `__Entity__` convention
   - GraphRAG v3 API uses `Entity` convention
   - Need to align or document the split

2. **Should we support both labels?**
   - Query could be: `MATCH (e) WHERE e:Entity OR e:__Entity__`
   - Or pick one standard and migrate

3. **Is this affecting other components?**
   - Check EnhancedGraphRetriever (uses MENTIONS edges - might have same issue)
   - Check AsyncNeo4jService methods (some use `__Entity__`)
   - Check DeterministicTracer

---

**Handover prepared**: January 4, 2026  
**Ready to resume**: Apply fix â†’ Deploy â†’ Test â†’ Celebrate ðŸŽ‰
