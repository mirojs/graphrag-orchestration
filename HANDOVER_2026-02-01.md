# Handover Document - February 1, 2026

## Objective
Test the **2-pass NLP extraction** (`response_type="comprehensive"`) to see if it achieves 16/16 ground truth accuracy for invoice/contract inconsistency detection.

## Background
- Previous V2 benchmark achieved **15/16** with `response_type="summary"`
- The `_comprehensive_two_pass_extract()` method exists in [synthesis.py](src/worker/hybrid_v2/pipeline/synthesis.py#L1069) but has **never been tested**
- Hypothesis: 2-pass extraction (structured NLP ‚Üí LLM enrichment) will prevent LLM fact-dropping

---

## Test Configuration

### Test Group
| Property | Value |
|----------|-------|
| **Group ID** | `test-5pdfs-v2-enhanced-ex` |
| **Entities** | 185 |
| **Documents** | 5 PDFs |
| **Text Chunks** | 17 |
| **Embedding Version** | V2 (Voyage 2048D) |

### API Endpoints
| Endpoint | URL | Status |
|----------|-----|--------|
| **Old (working)** | `https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io` | Has data access |
| **New (broken)** | `https://graphrag-api.salmonhill-df6033f3.swedencentral.azurecontainerapps.io` | No data access (wrong container) |

### Test Scripts
| Script | Purpose |
|--------|---------|
| `scripts/test_v1_v2_comprehensive.py` | V1 vs V2 comparison with comprehensive mode |
| `scripts/run_route4_question_bank.py` | Full question bank benchmark |

---

## Issues Discovered Today

### Issue 1: Deployment Goes to Wrong Container
**Status:** üü° Workaround in place

The `azure.yaml` was refactored to use `graphrag-api` as the service name, but the old container `graphrag-orchestration` is the one with proper environment variables and data access.

**Workaround:**
```bash
# After azd deploy, manually update old container with new image:
IMAGE=$(az containerapp show --name graphrag-api --resource-group rg-graphrag-feature --query "properties.template.containers[0].image" -o tsv)
az containerapp update --name graphrag-orchestration --resource-group rg-graphrag-feature --image "$IMAGE"
```

**Proper Fix Needed:** Update `azure.yaml` to use correct container name.

---

### Issue 2: JWT Middleware Overwrites group_id
**Status:** üî¥ Root cause identified, fix needed

**Root Cause:** In [src/api_gateway/middleware/auth.py](src/api_gateway/middleware/auth.py#L106-L108):
```python
else:
    # Auth not required, proceed with no claims
    request.state.group_id = None  # ‚Üê This OVERWRITES the group_id set by GroupIsolation!
```

**Middleware Order:**
1. GroupIsolation runs first ‚Üí sets `request.state.group_id = "test-5pdfs-v2-enhanced-ex"`
2. JWT middleware runs second ‚Üí overwrites `request.state.group_id = None`
3. Endpoint sees `None`, falls back to `"default"`

**Impact:** All queries use `group_id="default"` instead of the actual group, causing `get_all_chunks_comprehensive` to return 0 chunks.

**Fix Required:** Modify auth.py to preserve existing group_id:
```python
else:
    # Auth not required, proceed with no claims
    # Don't overwrite group_id if already set by GroupIsolation middleware
    if not getattr(request.state, "group_id", None):
        request.state.group_id = None
```

---

### Issue 3: Comprehensive Mode Gets 0 Text Chunks
**Status:** üü° Partially fixed

**Flow:**
1. Summary mode works (returns 5000+ chars) because it uses document overview metadata
2. Comprehensive mode needs actual text chunks to extract facts from
3. Entity-based retrieval returns 0 chunks (Route 4 doesn't produce good entity seeds)
4. Fallback `get_all_chunks_for_comprehensive()` added but fails due to Issue 2 (wrong group_id)

**Code Added:**
- [text_store.py](src/worker/hybrid_v2/indexing/text_store.py#L401): Added `get_all_chunks_for_comprehensive()` method
- [synthesis.py](src/worker/hybrid_v2/pipeline/synthesis.py#L1101): Added fallback to fetch all chunks

---

### Issue 4: llama-index Version Conflict (Resolved)
**Status:** ‚úÖ Fixed

Installing `llama-index-embeddings-voyageai` upgraded llama-index-core from 0.12.52 to 0.14.13, which added strict model validation rejecting `gpt-5.1` (Azure deployment name).

**Fix Applied:**
```bash
pip install llama-index-core==0.12.52
```

---

## Current State

### What Works
- Summary mode queries return full responses
- Route 4 (DRIFT multi-hop) works for complex queries
- Local tests can connect to Neo4j and retrieve chunks

### What Doesn't Work
- Comprehensive mode returns "No documents found to analyze" (30 chars)
- `get_all_chunks_for_comprehensive()` queries wrong group_id ("default")
- Route 2 (local_search) returns refusal messages

---

## TODO List

### Immediate (Blocking comprehensive test)
- [ ] **Fix auth.py middleware** - Don't overwrite group_id if already set
- [ ] **Deploy and verify** - Confirm `get_all_chunks_for_comprehensive` logs correct group_id
- [ ] **Run comprehensive test** - Score against 16-question ground truth

### Short-term
- [ ] **Fix azure.yaml deployment** - Make `azd deploy` target correct container
- [ ] **Investigate Route 2 refusal** - Why does local_search return "not found"?
- [ ] **Add monitoring** - Log group_id in all middleware for debugging

### Testing
- [ ] Run `scripts/test_v1_v2_comprehensive.py` with fixed deployment
- [ ] Compare comprehensive vs summary mode scores
- [ ] Document results in benchmark file

---

## Commands Reference

### Deploy and Update Container
```bash
cd /afh/projects/graphrag-orchestration
azd deploy --all
IMAGE=$(az containerapp show --name graphrag-api --resource-group rg-graphrag-feature --query "properties.template.containers[0].image" -o tsv)
az containerapp update --name graphrag-orchestration --resource-group rg-graphrag-feature --image "$IMAGE"
```

### Test Comprehensive Mode
```bash
curl -s -X POST "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/query" \
  -H "Content-Type: application/json" \
  -H "X-Group-Id: test-5pdfs-v2-enhanced-ex" \
  -d '{"query": "Find inconsistencies between invoice amounts and contract terms", "response_type": "comprehensive"}' | jq '{response_len: (.response | length), text_chunks: .metadata.text_chunks_used}'
```

### Check Logs
```bash
az containerapp logs show --name graphrag-orchestration --resource-group rg-graphrag-feature --tail 100 | grep -E "comprehensive|group_id"
```

### Local Test
```bash
cd /afh/projects/graphrag-orchestration
export PYTHONPATH=/afh/projects/graphrag-orchestration
python scripts/test_v1_v2_comprehensive.py
```

---

## Files Modified Today

| File | Change |
|------|--------|
| `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md` | Added 2-pass extraction analysis section |
| `scripts/test_v1_v2_comprehensive.py` | Changed `response_type="summary"` ‚Üí `"comprehensive"` |
| `src/worker/hybrid_v2/pipeline/synthesis.py` | Added fallback chunk retrieval for comprehensive mode |
| `src/worker/hybrid_v2/indexing/text_store.py` | Added `get_all_chunks_for_comprehensive()` method |

---

## Next Session Start Point

1. **Apply auth.py fix** (line 106-108) to preserve group_id
2. **Deploy** using the workaround commands above
3. **Verify** logs show correct group_id in `get_all_chunks_for_comprehensive`
4. **Run comprehensive test** and compare to 15/16 summary baseline
