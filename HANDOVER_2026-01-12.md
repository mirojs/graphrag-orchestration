# Handover - January 12, 2026

## Critical Finding: Missing MENTIONS Edges

### Investigation Summary

While analyzing Route 3 performance issues (low citation accuracy with `cite_jacc_min=0.00` and `path_jacc_min=0.00`), we discovered the **root cause**:

**The Neo4j graph has ZERO `MENTIONS` edges** connecting chunks to entities.

### Diagnostic Results

Created and ran `inspect_neo4j_mentions.py` script against the production Neo4j Aura instance:

| Metric | Value | Status |
|--------|-------|--------|
| **MENTIONS edges** | **0** | âŒ **MISSING** |
| Total entities | 147 | âœ… Present |
| Synthetic `doc_*` entities | 31 | âš ï¸ Present but orphaned |
| Real entities (e.g., "Documents", "Building Arbitration Rules") | Present | âœ… Found |
| Chunks | Present (assumed) | âœ… Assumed present |

### Impact

Without `(Chunk)-[:MENTIONS]->(Entity)` relationships:

1. **Route 3 PPR (Personalized PageRank)** cannot traverse from query-relevant entities to their source chunks
2. **Citation accuracy metrics** remain at 0% because no chunkâ†’entity paths exist
3. **Entity-based retrieval** is completely broken despite entities existing in the graph

### Why This Matters

The entire Route 3 LazyGraphRAG architecture depends on:
```
Query â†’ Relevant Entities â†’ [MENTIONS edges] â†’ Source Chunks â†’ Answer
```

Without the MENTIONS edges, the middle step fails, and the system cannot retrieve supporting evidence for entity-based queries.

---

## What Works vs What Doesn't

### âœ… What's Working
- Entity extraction and storage in Neo4j (147 entities present)
- Entity embeddings (based on prior testing)
- Route 1 (lexical/semantic retrieval) - doesn't use MENTIONS
- Route 2 (hybrid retrieval) - doesn't use MENTIONS
- Basic graph structure (nodes exist)

### âŒ What's Broken
- Route 3 entityâ†’chunk traversal (PPR)
- Citation source tracking via graph paths
- Any query flow requiring `MENTIONS` relationships
- Chunk-to-entity connectivity metrics

---

## Root Cause Analysis

### Hypothesis 1: Indexing Pipeline Never Created MENTIONS Edges

The GraphRAG indexing pipeline may have:
- Successfully extracted entities from chunks
- Stored entities in Neo4j
- **Failed to create the `MENTIONS` relationship** between `(Chunk)-[:MENTIONS]->(Entity)`

**Evidence:**
- Entities exist (147 total)
- Chunks likely exist (based on prior query results)
- Zero MENTIONS edges found

### Hypothesis 2: Migration or Schema Change Lost Edges

The Cypher 2.5 migration on Jan 10-11 may have:
- Recreated entity nodes successfully
- Lost or failed to migrate MENTIONS relationships

**Evidence:**
- Recent migration to Cypher 2.5 Neo4j-GraphRAG SDK
- Multiple deployment/reindex operations on Jan 10-12
- Benchmark results show consistent 0% citation accuracy post-migration

---

## Files Created/Modified Today

### New Diagnostic Script
- **`inspect_neo4j_mentions.py`** - Neo4j graph structure inspection tool
  - Queries MENTIONS edge statistics
  - Samples entity properties
  - Tests for synthetic vs real entities
  - Validates chunkâ†’entity connectivity

### Configuration
- Fixed Pydantic v2 deprecation warnings (switched to `SettingsConfigDict`)
- Configured to read `.env` from `graphrag-orchestration/graphrag-orchestration/.env`
- Added `extra="ignore"` to handle full application `.env` file

---

## Benchmark Context

Recent Route 3 benchmarks showing the impact:

### Latest Results (Jan 12, 2026)
```
bench_route3_final_validation_20260112_1440.txt:
  Q-G1: cite_jacc_min=0.00 path_jacc_min=0.00
  Q-G2: cite_jacc_min=0.00 path_jacc_min=0.00
```

### Pattern Across All Recent Tests
All Route 3 tests since Jan 10 show:
- `cite_jacc_min=0.00` (no citation overlap)
- `path_jacc_min=0.00` (no path overlap)
- Variable semantic accuracy (route still produces answers via other mechanisms)

---

## TODO List - Next Session

### ðŸ”´ Priority 1: Fix MENTIONS Edge Creation

#### Option A: Full Re-Index (Recommended)
1. **Verify indexing pipeline creates MENTIONS**
   - Check `graphrag-orchestration/app/services/indexing_service.py`
   - Trace entity extraction â†’ graph storage flow
   - Confirm MENTIONS relationship creation in Neo4j write operations

2. **Test on Small Dataset First**
   - Create new test group with 1-2 PDFs
   - Run indexing pipeline
   - Verify MENTIONS edges appear in Neo4j
   - If successful, proceed to full re-index

3. **Re-Index Production Group**
   - Re-index `test-5pdfs-cypher25-1768222317` group
   - Monitor MENTIONS edge creation in real-time
   - Validate chunkâ†’entity connectivity post-index

#### Option B: Migration Script (Faster, If Data Exists)
1. **Check if mention data exists elsewhere**
   - Query Neo4j for stored mention metadata in chunk properties
   - Check LanceDB or other vector stores for mention records
   - Look for any stored entityâ†’chunk mappings

2. **Create backfill script if data found**
   - Write Cypher query to create MENTIONS edges from existing data
   - Test on small subset
   - Apply to full graph

3. **Validate results**
   - Re-run `inspect_neo4j_mentions.py`
   - Confirm MENTIONS edge count > 0
   - Spot-check entityâ†’chunk paths

### ðŸŸ¡ Priority 2: Benchmark Validation

After fixing MENTIONS edges:

1. **Run Route 3 smoke test**
   ```bash
   python test_5pdfs_comprehensive.py --route 3 --questions 3
   ```

2. **Check citation metrics**
   - Verify `cite_jacc_min > 0.00`
   - Verify `path_jacc_min > 0.00`
   - Confirm chunk sources are populated

3. **Run full benchmark suite**
   - 10-question test on Route 3
   - Compare against baseline from Jan 7-9
   - Document performance improvement

### ðŸŸ¢ Priority 3: Documentation & Prevention

1. **Update deployment checklist**
   - Add MENTIONS edge validation step post-index
   - Add `inspect_neo4j_mentions.py` to standard diagnostic tools
   - Document expected edge counts per document

2. **Add monitoring**
   - Create health check endpoint that validates MENTIONS edges exist
   - Alert if edge count drops unexpectedly
   - Track edge count as deployment metric

3. **Schema documentation**
   - Document required relationships: MENTIONS, RELATED, etc.
   - Add validation queries to CI/CD
   - Create graph schema diagram

---

## Key Code Locations

### Indexing Pipeline
- **Main service**: `graphrag-orchestration/app/services/indexing_service.py`
- **Neo4j adapter**: `graphrag-orchestration/app/services/neo4j_service.py`
- **Entity extraction**: Likely in GraphRAG SDK or custom extraction logic

### Neo4j Query Patterns
- **Route 3 retrieval**: `graphrag-orchestration/app/services/search/strategies/route3_*.py`
- **PPR implementation**: Check for Cypher queries using `algo.pageRank` or similar

### Configuration
- **Neo4j connection**: `graphrag-orchestration/.env`
  - `NEO4J_URI=neo4j+s://a86dcf63.databases.neo4j.io`
  - Database: `neo4j`
  - Group ID: `test-5pdfs-cypher25-1768222317`

---

## Open Questions

1. **When did MENTIONS edges disappear?**
   - Was it during Cypher 2.5 migration (Jan 10-11)?
   - Or were they never created in this deployment?

2. **What does the indexing pipeline actually create?**
   - Does it call neo4j-graphrag SDK's indexing?
   - Or custom logic?
   - Where's the MENTIONS relationship supposed to be created?

3. **Are there other missing relationships?**
   - Should we audit RELATED, PART_OF, or other edge types?
   - Is the entire graph connectivity broken or just MENTIONS?

---

## Environment Details

### Neo4j Aura Instance
- **URI**: `neo4j+s://a86dcf63.databases.neo4j.io`
- **Database**: `neo4j`
- **Instance**: `a86dcf63` (Instance01)
- **SDK**: neo4j-graphrag 1.12.0
- **Cypher version**: 2.5 (migrated Jan 10-11)

### Test Group
- **Group ID**: `test-5pdfs-cypher25-1768222317`
- **Documents**: 5 PDFs
- **Entities**: 147 (all orphaned without MENTIONS edges)
- **Created**: ~Dec 24-25, 2025 (based on question bank date)

### Deployment
- **Container App**: `graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io`
- **Latest deployment**: Jan 12, 2026 14:06 UTC
- **Region**: Sweden Central
- **Image**: `graphragacr12153.azurecr.io/graphrag-orchestration:latest`

---

## Recent Deployment History (Jan 10-12)

- **Jan 10**: Cypher 2.5 migration, phase 1 index fixes
- **Jan 11**: Relationship fixes, limit parameter fixes
- **Jan 12**: Multiple PPR limit fixes, mentions investigation (today)

All deployments since Jan 10 show 0% citation accuracy in Route 3 benchmarks.

---

## Next Session Action Items

1. **Immediate**: Run diagnostic queries in Neo4j browser
   ```cypher
   // Check if chunks exist
   MATCH (c:Chunk) WHERE c.group_id = "test-5pdfs-cypher25-1768222317" 
   RETURN count(c) as chunk_count;
   
   // Check for any MENTIONS edges (should be 0 based on our finding)
   MATCH (c)-[m:MENTIONS]->(e) WHERE c.group_id = "test-5pdfs-cypher25-1768222317"
   RETURN count(m) as mentions_count;
   ```

2. **Code review**: Trace indexing pipeline entityâ†’MENTIONS creation logic

3. **Decision**: Choose Option A (re-index) vs Option B (migration) based on code review

4. **Execute fix**: Implement chosen solution

5. **Validate**: Run benchmarks and confirm citation metrics improve

---

## Success Criteria

Fix is complete when:
- [ ] `inspect_neo4j_mentions.py` shows `total_mentions > 0`
- [ ] Route 3 benchmarks show `cite_jacc_min > 0.00`
- [ ] Route 3 benchmarks show `path_jacc_min > 0.00`
- [ ] Sample queries return proper source citations with chunk IDs
- [ ] Performance matches or exceeds Jan 7-9 baseline

---

## Contact & Continuation

- **Environment**: `.venv` activated, Python 3.10
- **Diagnostic script**: `inspect_neo4j_mentions.py` (ready to use)
- **Last deployment**: Jan 12, 2026 14:06 UTC
- **Status**: Root cause identified, ready for fix implementation

**Ready to continue when you return tomorrow!** ðŸš€
