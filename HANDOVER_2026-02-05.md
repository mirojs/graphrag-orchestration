# Handover - February 5, 2026

## Summary

Reviewed Route 3 and Route 4 for potential improvements, applied upstream fix, cleaned up container app revisions.

---

## Completed Today

### 1. Route 3 Improvement Plan
- **File:** [PLAN_ROUTE3_IMPROVEMENTS_2026-02-05.md](PLAN_ROUTE3_IMPROVEMENTS_2026-02-05.md)
- **Scope:** Port Route 4's enhanced coverage gap fill to Route 3
- **Changes planned:**
  - Add document-level tracking (`existing_docs` set)
  - Dynamic sizing based on corpus
  - Early exit when full coverage achieved
  - Comprehensive query detection ("list all", "summarize across")
- **Status:** Plan documented, code not yet implemented

### 2. Route 2 Assessment
- **Verdict:** Keep as-is (100% accuracy, stable)
- **Reason:** No improvements needed; section-aware diversification already on roadmap

### 3. Upstream Fix Applied
- **Commit:** `ff018f73` - Cherry-pick upstream fix 8883e727
- **Fix:** Multimodal image download from non-default blob container
- **Files updated:**
  - `frontend/app/backend/approaches/approach.py`
  - `frontend/app/backend/prepdocslib/blobmanager.py`
  - `frontend/tests/test_app.py`
  - `frontend/UPSTREAM_VERSION.md`

### 4. Container URL Migration
- **Commit:** `35582bd6`
- **Change:** Updated 47 files from deprecated `graphrag-orchestration` URL to `graphrag-api`
- **Correct architecture:**
  - `graphrag-api` = Frontend (external, auth required)
  - `graphrag-worker` = Backend (internal only)
  - `graphrag-orchestration` = Deprecated

### 5. Container App Cleanup
- **App:** `graphrag-api`
- **Before:** 28 active revisions (all running)
- **After:** 1 active revision (`graphrag-api--azd-1770281048`)
- **Benefit:** Cleaner log streaming, reduced resource consumption

### 7. Worker Container Cleanup
- **App:** `graphrag-worker`
- **Before:** 19 active revisions
- **After:** 1 active revision (`graphrag-worker--r21706787597`)
- **Benefit:** Fixed Route 4 log visibility, consistent log streaming

### 8. Route 4 Benchmark & Evaluation
- **Benchmark:** `route4_drift_multi_hop_20260205T115442Z.json`
- **Group:** `test-5pdfs-v2-fix2` (5 PDFs indexed)
- **Questions:** 11 evaluated (Q-D1-D7, Q-D9, Q-N1-N3)
- **LLM Judge:** GPT-5.1
- **Results:**
  - Total Score: 32/33 (97.0%)
  - Pass Rate (≥2/3): 100%
  - All queries answered correctly
  - Only Q-D5 scored 2/3 (acceptable, minor verbosity)
- **Known Issue:** DRIFT synthesis produces overly verbose responses in summary mode
  - Root cause: Prompt instructs LLM to synthesize "ALL sub-questions" comprehensively
  - Impact: Q-D5 returned 5,655 chars (expected ~150 chars)
  - Documentation: [PROMPT_IMPROVEMENT_DRIFT_SYNTHESIS_2026-02-05.md](PROMPT_IMPROVEMENT_DRIFT_SYNTHESIS_2026-02-05.md)
  - Recommendation: Response-type-aware synthesis prompt (defer to later tuning)
- **Files:**
  - Benchmark: `benchmarks/route4_drift_multi_hop_20260205T115442Z.json`
  - Evaluation: `benchmarks/route4_drift_multi_hop_20260205T115442Z.eval.md`
  - Log: `llm_eval_route4_20260205_143906.txt`

### 6. Evaluation Assessment
- **Current state:** Functional but could be improved
- **Verdict:** Skip tooling complexity for now (100% accuracy on 5-PDF corpus)
- **Future backlog:**
  - Expanded test corpus (20+ documents)
  - Latency threshold assertions in CI
  - Negative test audit (Q-N* coverage)

---

## Current Infrastructure

| Component | URL/Name | Status |
|-----------|----------|--------|
| **Frontend (B2B)** | `graphrag-api.salmonhill-df6033f3.swedencentral.azurecontainerapps.io` | ✅ Running |
| **Frontend (B2C)** | `graphrag-api-b2c.salmonhill-df6033f3.swedencentral.azurecontainerapps.io` | ✅ Running |
| **Backend Worker** | `graphrag-worker.internal.salmonhill-df6033f3...` | ✅ Internal |
| **Auth App ID** | `api://b68b6881-80ba-4cec-b9dd-bd2232ec8817` | B2B Entra ID |
| **Test Group** | `test-5pdfs-v2-fix2` | 5 PDFs indexed |

---

## Pending Upstream PR

- **PR #2953:** Prompty → Jinja2 migration
- **Status:** Open (not merged)
- **Action:** Wait until merged, then evaluate for sync

---

## Todo List

### High Priority
- [ ] **Implement Route 3 improvements** - Apply changes from [PLAN_ROUTE3_IMPROVEMENTS_2026-02-05.md](PLAN_ROUTE3_IMPROVEMENTS_2026-02-05.md)
- [x] **Run Route 4 benchmark** - LLM evaluation: 97% (32/33), 100% pass rate ✅
- [x] **Clean up `graphrag-worker` revisions** - 19 revisions → 1 active (fixes log streaming)

### Medium Priority
- [ ] **Clean up `graphrag-orchestration` revisions** - If still used (deprecated service)

### Low Priority (Backlog)
- [ ] **Improve DRIFT synthesis prompt** - See [PROMPT_IMPROVEMENT_DRIFT_SYNTHESIS_2026-02-05.md](PROMPT_IMPROVEMENT_DRIFT_SYNTHESIS_2026-02-05.md) (Q-D5 verbosity issue)
- [ ] Expand test corpus to 20+ documents
- [ ] Add latency thresholds to CI
- [ ] Audit Q-N* negative tests
- [ ] Sync upstream PR #2953 when merged

---

## Quick Commands

### Run Route 4 Benchmark
```bash
cd /afh/projects/graphrag-orchestration
python scripts/benchmark_route4_drift_multi_hop.py --repeats 3 --group-id test-5pdfs-v2-fix2
```

### Get Auth Token
```bash
az account get-access-token --resource api://b68b6881-80ba-4cec-b9dd-bd2232ec8817 --query accessToken -o tsv
```

### Test API Health
```bash
TOKEN=$(az account get-access-token --resource api://b68b6881-80ba-4cec-b9dd-bd2232ec8817 --query accessToken -o tsv)
curl -H "Authorization: Bearer $TOKEN" https://graphrag-api.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/health
```

### View Container Logs
```bash
# API Gateway logs (auth, health checks, HTTP requests)
az containerapp logs show --name graphrag-api --resource-group rg-graphrag-feature --tail 50

# Worker logs (Route 2/3/4 query execution, indexing)
az containerapp logs show --name graphrag-worker --resource-group rg-graphrag-feature --tail 50
```

**⚠️ Logging Architecture Note:**
- `graphrag-api` logs show: authentication, health checks, API endpoints
- `graphrag-worker` logs show: Route 4 execution, query processing, entity extraction
- **Issue:** Route 4 query logs only appear in `graphrag-worker`, not `graphrag-api`
- When testing Route 4, must check **worker logs** to see query execution details

---

## Git Status

```
Latest commits:
35582bd6 - chore: Update deprecated graphrag-orchestration URL to graphrag-api
ff018f73 - Cherry-pick upstream fix 8883e727
d3f5a7aa - Add Route 3 improvement plan
```

All changes pushed to `main`.
