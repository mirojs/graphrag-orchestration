# Session Handover — 2026-02-19
**Focus:** Section summary comparison, tier contribution analysis, architecture evaluation

---

## 1. NLP vs LLM Section Summary Comparison (Completed)

Tested three approaches for Tier 2 structural embedding text (`title | path_key -- summary`):

| Approach | Avg Top-1 Cosine Similarity | Method |
|----------|---------------------------|--------|
| **LLM (gpt-4.1)** | **0.3241** | 1-2 sentence summary from chunk content |
| TF-IDF keywords | 0.3100 | Top-15 corpus-wide TF-IDF terms (bigram-inclusive) |
| TextRank extractive | 0.3061 | Top-2 sentences via PageRank on intra-section similarity |

**Conclusion:** LLM summaries win by ~5%. NLP approaches outperform bare titles but can't match LLM's ability to capture semantic intent. LLM summaries should be used for structural embeddings.

**Scripts created:**
- `scripts/nlp_section_summarizer.py` — Reusable TF-IDF and TextRank module
- `scripts/benchmark_section_summary_comparison.py` — Full comparison with `--generate-llm-summaries` flag

---

## 2. Q-D3 "Time Windows" Failure (Root Cause Found)

**Query:** _"Compare time windows across the set: list all explicit day-based timeframes."_

**PURCHASE CONTRACT** contains "90 days", "3 business days", "8-10 weeks" in its chunks but ranks **dead last (12th of 12)** in structural matching and **outside top-20** in sentence vector search.

### Root cause: Dual failure at both retrieval paths

**Path 1 — Structural matching (Tier 2):**
All three summarization approaches (LLM, TF-IDF, TextRank) drop the time terms. The LLM summary says "obligation to furnish and install a vertical platform lift" — zero mention of any timeframes. TF-IDF surfaces `contractor, risk, cancel` instead.  This is by design — the structural tier identifies sections, not details.

**Path 2 — Sentence vector search:**
The sentences containing "90 days", "3 business days" exist in the `sentence_embeddings_v2` index with proper embeddings. But when searched against the query "time windows / day-based timeframes", they score **below position 20**. WARRANTY and PROPERTY MANAGEMENT sentences dominate because they use verbose language about coverage periods. The bi-encoder (Voyage) maps "time windows" far from "Contractor warrants labor for 90 days" in embedding space.

The reranker (Voyage rerank-2.5) can't help because it only operates on what vector search retrieves — PURCHASE CONTRACT sentences are filtered out before reranking.

**Where keyword/BM25 search fills the gap:**
BM25 would directly match "days" and "weeks" tokens. The fulltext infrastructure already exists in the codebase (`textchunk_fulltext` index, `_search_text_chunks_fulltext()` method), but it's not wired into seed resolution.

---

## 3. Tier Contribution Analysis (Completed)

Ran all 20 benchmark questions through the live Route 5 API and extracted `tier_contribution` metadata.

### Key findings:

**Tier 3 (Community/Thematic) is completely dead — 0 seeds across all 20 questions.**
Root cause: zero `:Community` nodes exist in Neo4j for group `test-5pdfs-v2-fix2`. The Louvain community detection step was never run. Weight w3=0.2 gets redistributed to Tiers 1 and 2.

**Tier 1 (NER) mostly hallucinates entity names:**
- 4/20 queries produce no NER entities (too abstract: "time windows", "latest date", "named parties", "main purpose")
- ~14/20 queries produce hallucinated concept names ("Termination Clause", "Insurance Policy", "Fee Schedule") that don't exist as real entities in the graph — they fuzzy-match to semi-random graph nodes
- Only ~2/20 queries produce genuinely useful entities (Q-D8: "Fabrikam Inc.", "Contoso Ltd.")
- This is because HippoRAG 2's NER was designed for entity-anchored queries ("What did Company X do?"), not concept-anchored queries ("Compare termination rules")

**Tier 2 (Structural) dominates by count but is diluted by weight:**
- Avg 37 seeds per query → per-seed weight ~0.014
- Tier 1 avg 7.7 seeds → per-seed weight ~0.08
- Per-seed weight ratio: T1 is 1.6x to 35x higher than T2

### Summary table:

| QID | Profile | T1 cnt | T1 mass | T2 cnt | T2 mass | T3 cnt | T3 mass |
|-----|---------|--------|---------|--------|---------|--------|---------|
| Avg | balanced | 7.7 | 0.787 | 37.0 | 0.579 | 0.0 | 0.000 |

**Script created:** `scripts/tier_contribution_analysis.py`

---

## 4. Architecture Evaluation — Entity vs Concept Search

### Current architecture gaps:

```
Sentence Vector Search (parallel, independent)
   → Goes directly to synthesizer as "coverage_chunks"
   → Does NOT contribute to PPR seeds (except in non-default bottom_up mode)
   → This is the highest quality retrieval but it doesn't inform PPR

PPR Path (3-tier seeds):
   → Tier 1 (NER): Hallucinates concept names, rarely finds real entities
   → Tier 2 (Structural): Section matching → entity extraction, good coverage but diluted
   → Tier 3 (Community): Dead — no community nodes indexed
```

### The concept search problem:

Even with perfect seeds, PPR walks an **entity-centric** graph. Concepts ("time windows", "termination rules") aren't entity nodes — they're abstractions over content. The concept reasoning happens at the edges (sentence search + LLM synthesis), but the middle of the pipeline (entity extraction → PPR → chunk retrieval) loses the concept signal.

**Community matching (Tier 3) was designed to bridge this gap** — community summaries describe themes/concepts. But with zero communities indexed, this capability is missing entirely.

### Proposed architecture changes:

1. **Promote sentence vector search to primary seed source (new Tier 1):**
   - Find relevant sentences by embedding similarity
   - Extract entities from matched sentences → PPR seeds
   - Grounded in real document content, zero hallucination

2. **Demote NER to lightweight boost:**
   - Only keep exact name matches (no fuzzy/vector fallback)
   - Eliminates hallucinated concept names
   - Preserves NER's strength for explicit entity queries ("What did Fabrikam do?")

3. **Fix community indexing (Tier 3):**
   - Run Louvain community detection for the test group
   - Community summaries become the concept-level seed source
   - Critical for concept-anchored queries

4. **Reclassify query routing from global/drift to entity/concept:**
   - Entity queries → weight PPR-heavy (semantic seeds → PPR walk)
   - Concept queries → weight community-heavy (community matching + community context)
   - Cleaner split than current profiles

### Graph structure findings:

- **363 Entity nodes**, 907 `RELATED_TO` edges, 286 `MENTIONS` edges from TextChunks
- **18 TextChunks** containing **185 Sentences** (15.4 sentences per chunk) — **not** sentence-based chunking
- `MENTIONS` edges are chunk-level, not sentence-level — every sentence in a chunk inherits all entities from fellow sentences (noisy)
- **Zero `:Community` nodes** — Louvain step never ran
- Sentence nodes only have structural relationships: `PART_OF`, `IN_SECTION`, `IN_DOCUMENT`, `NEXT`

### Note on sentence-based chunking:

The current test group (`test-5pdfs-v2-fix2`) uses **section-level chunks** (~15 sentences per chunk), not sentence-based chunking. If re-indexed with true sentence-based chunking (1 chunk = 1 sentence):
- `TextChunk-[:MENTIONS]->Entity` becomes sentence-level entity extraction
- Semantic search → entity derivation becomes clean and precise
- PPR seeds from matched sentences would be tightly scoped instead of inheriting all entities from a 15-sentence chunk

---

## 5. Commits Pushed (2026-02-19)

1. `eb8cafb` — fix: use voyageai client directly in section summary benchmark (Voyage API fixes)
2. `7585be0` — feat: add --generate-llm-summaries to section summary benchmark

---

## 6. Open Items

| Priority | Item | Status |
|----------|------|--------|
| **P0** | Fix community indexing (run Louvain for test group) | Not started |
| **P0** | Re-evaluate Tier 3 after communities are indexed | Blocked on above |
| **P1** | Wire BM25/fulltext search into seed resolver | Designed, not implemented |
| **P1** | Promote sentence search to seed source (new Tier 1) | Architecture proposed |
| **P1** | Re-index with sentence-based chunking | Requires pipeline change |
| **P2** | Demote NER to exact-match-only boost | Depends on new Tier 1 |
| **P2** | Reclassify routing: entity/concept vs global/drift | Depends on community fix |
