# Handover Document - January 14, 2026

## Session Summary

Today’s work focused on **Route 4 (DRIFT multi-hop)** observability and robustness, specifically addressing the confusing runtime telemetry pattern where many requests show:
- `seed_entities=[]`
- `total_unique_seeds=0`
- `num_evidence=0`
- `num_chunks=0`

…followed by successful query-based fallback retrieval (`text_chunks_query_fallback`) and a non-empty answer.

We confirmed this is often a *normal* Route 4 path (when no useful graph entities can be extracted), and updated the pipeline to reduce misleading “0” log spam and treat “unresolved seeds” as non-graph (fallback) rather than evidence.

---

## Current Deployed State (Azure Container Apps)

- App URL: https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io
- Latest revision during session: `graphrag-orchestration--0000214`
- Latest image deployed: `graphragacr12153.azurecr.io/graphrag-orchestration:main-6a62b2e-20260114145953`
- Test corpus group id used for smoke/bench: `test-5pdfs-section-20260114T072858Z`

---

## What Changed Today (Code)

### 1) Route 4 seed filtering: drop generic non-entity “seeds”
**File:** `graphrag-orchestration/app/hybrid/pipeline/intent.py`

- Added a normalization + denylist-based filter for common finance/payment abbreviations and phrases that are *not* meaningful graph entities in this corpus.
- Examples filtered: `ACH`, `SWIFT`, `IBAN`, `BIC`, `routing number(s)`, etc.

Expected impact:
- Fewer generic “entities” that can’t be resolved in Neo4j.
- Cleaner seed lists and less wasted tracing work.

### 2) Route 4 tracing: treat “seeds not found in Neo4j” as normal fallback case
**File:** `graphrag-orchestration/app/hybrid/pipeline/tracing.py`

- If `seed_entities` is empty: return `[]` early (no warning).
- If seeds exist but **none resolve** in Neo4j for this `group_id`: log `seed_entities_not_resolved` at **info** and return `[]` evidence.

Expected impact:
- Removes misleading `no_seed_entities_found` warnings for non-graph cases.
- Prevents “fake evidence nodes” from flowing downstream.

### 3) Route 4 synthesis: avoid misleading entity-chunk “0 chunks” logging when there are no entities
**File:** `graphrag-orchestration/app/hybrid/pipeline/synthesis.py`

- If there are **zero selected entities**, `_retrieve_text_chunks()` returns `[]` immediately.

Expected impact:
- Prevents an extra noisy “0 chunks retrieved” log in the normal fallback path.

---

## Verified Behavior (Post-Deploy)

A Route 4 query like:
- “What is the bank routing number?”

Now commonly shows:
- `intent_disambiguation_success` producing either empty seeds or a small set
- if seeds don’t resolve: `seed_entities_not_resolved` (info)
- `stage_4.3_complete num_evidence=0`
- `text_chunks_query_fallback num_chunks=8`

So the logs clearly communicate: **graph path not applicable → fallback retrieval used**.

---

## Known Issues / Open Questions

1. **Citations often empty in DRIFT responses** even when query fallback returns chunks.
   - Likely the fallback chunks aren’t being turned into citation objects (chunk_id/source/page).
   - This reduces evaluability and user trust.

2. **Some prompts/questions produce generic seeds anyway** (depending on LLM output).
   - The denylist is a heuristic; may need expansion or better “entity-ness” scoring.

3. **Benchmark remaining failure(s)**
   - There was at least one negative question (Q‑N6) previously failing; still needs investigation and resolution.

---

## TODO List (for tomorrow)

### P0 — Make Route 4 citations reliable
- Ensure `text_chunks_query_fallback` produces citations with `chunk_id` + doc metadata (source/page/section) when available.
- Add a small regression test (or a benchmark assertion) that fallback path returns non-empty `citations` when chunks are used.

### P0 — Re-run Route 4 benchmark after today’s changes
- Run `scripts/benchmark_route4_drift_multi_hop.py` against `test-5pdfs-section-20260114T072858Z`.
- Compare:
  - negative accuracy (especially Q‑N6)
  - telemetry cleanliness (fewer “0” events that look like failures)

### P1 — Investigate Q‑N6 failure specifically
- Check whether the question is truly unanswerable from the corpus.
- If truly negative: strengthen the strict-negative suffix/instruction for Route 4 as well.
- If answerable: identify missing chunk retrieval / entity linking gap.

### P1 — Decide what “good telemetry” should be
- Clarify expected metrics for fallback cases:
  - `total_unique_seeds=0` can be normal
  - `num_evidence=0` can be normal
  - `text_chunks_used` should reflect fallback chunk count

### P2 — Optional: reduce Route 4 latency
- Consider short-circuiting decomposition/tracing more aggressively when:
  - disambiguation produces no/low-quality seeds for multiple sub-questions
  - query fallback retrieval already finds high-confidence chunks

---

## Files Changed Today

- `graphrag-orchestration/app/hybrid/pipeline/intent.py`
- `graphrag-orchestration/app/hybrid/pipeline/tracing.py`
- `graphrag-orchestration/app/hybrid/pipeline/synthesis.py`

---

*End of handover - January 14, 2026*
