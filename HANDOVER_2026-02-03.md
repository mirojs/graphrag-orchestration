# Handover - 2026-02-03

## Session Summary

Completed **folder isolation layer** implementation for the GraphRAG query pipeline. This adds an optional `folder_id` filter that scopes search results to documents within a specific folder, as an additional isolation layer under `group_id`.

## Key Insight: Runtime Filter Pattern

Both `group_id` and `folder_id` use **post-filtering** (oversample → filter), meaning:
- **No reindexing required** when adding folder filtering
- Vector index returns global top-K, then filtered by relationships
- `(:Document)-[:IN_FOLDER]->(:Folder)` relationship used at query time

## Files Modified

### 1. API Gateway Layer
- **[src/api_gateway/routers/chat.py](src/api_gateway/routers/chat.py)**
  - Added `folder_id: Optional[str] = Query(None)` to all chat endpoints
  - Updated `_get_hybrid_pipeline()`, `_execute_query()`, `_submit_async_job()`
  - Updated `_execute_async_job()`, `_stream_chat_response()`
  - Updated `ChatJobTracker.create()` to track folder_id

- **[src/api_gateway/routers/folders.py](src/api_gateway/routers/folders.py)**
  - Added document-folder assignment endpoints:
    - `POST /{folder_id}/documents` - assign single document
    - `DELETE /{folder_id}/documents/{document_id}` - unassign document
    - `POST /{folder_id}/documents/bulk` - bulk assign documents
    - `GET /{folder_id}/documents` - list documents in folder
    - `GET /unfiled/documents` - list documents not in any folder

### 2. Orchestrator Layer
- **[src/worker/hybrid_v2/orchestrator.py](src/worker/hybrid_v2/orchestrator.py)**
  - Added `folder_id: Optional[str] = None` parameter to `__init__`
  - Stored as `self.folder_id`
  - Passes folder_id to all pipeline components

### 3. Route Handlers
- **[src/worker/hybrid_v2/routes/base.py](src/worker/hybrid_v2/routes/base.py)**
  - Added `self.folder_id = folder_id` storage
  - Added helper methods:
    - `_build_folder_filter()` - returns Cypher WHERE clause
    - `_get_folder_params()` - returns query params dict
  - Updated `_search_text_chunks_fulltext()` with folder filtering
  - Updated `_search_via_entity_graph()` with folder filtering

### 4. Pipeline Components

#### CommunityMatcher, HubExtractor, DeterministicTracer
- Added `folder_id: Optional[str] = None` parameter to `__init__`
- Stored as `self.folder_id`

#### EnhancedGraphRetriever - COMPREHENSIVE UPDATE
- **[src/worker/hybrid_v2/pipeline/enhanced_graph_retriever.py](src/worker/hybrid_v2/pipeline/enhanced_graph_retriever.py)**
  - Added `folder_id: Optional[str] = None` parameter to `__init__`
  - Added helper methods:
    - `_get_folder_filter_clause(doc_alias)` - returns Cypher WHERE clause
    - `_get_folder_params()` - returns query params dict
  - **Updated 12+ retrieval methods with folder filtering:**
    - `get_all_documents()` - ✅ folder filter on Document nodes
    - `get_documents_by_date()` - ✅ folder filter on Document nodes
    - `get_coverage_chunks()` - ✅ folder filter on Document→TextChunk
    - `get_coverage_chunks_semantic()` - ✅ folder filter on Document→TextChunk
    - `get_all_sections_chunks()` - ✅ folder filter via OPTIONAL MATCH
    - `get_document_lead_chunks()` - ✅ folder filter on Document→TextChunk
    - `get_keyword_boost_chunks()` - ✅ folder filter via OPTIONAL MATCH
    - `get_section_boost_chunks()` - ✅ folder filter via OPTIONAL MATCH
    - `get_section_id_boost_chunks()` - ✅ folder filter via OPTIONAL MATCH
    - `get_summary_chunks_by_section()` - ✅ folder filter on Document→TextChunk

#### HubExtractor
- **[src/worker/hybrid_v2/pipeline/hub_extractor.py](src/worker/hybrid_v2/pipeline/hub_extractor.py)**
  - Updated `_diversify_entities_by_document()` with folder filtering

## Folder Filtering Pattern

Two patterns used depending on query structure:

### Pattern 1: Direct Document Match
```cypher
-- Used when Document is in MATCH clause
MATCH (d:Document)<-[:IN_DOCUMENT]-(t:TextChunk)
WHERE d.group_id = $group_id
{folder_filter}  -- AND ($folder_id IS NULL OR (d)-[:IN_FOLDER]->(:Folder {id: $folder_id}))
```

### Pattern 2: Optional Document Match
```cypher
-- Used when Document is in OPTIONAL MATCH clause
OPTIONAL MATCH (t)-[:IN_DOCUMENT]->(d:Document)
WHERE d IS NULL OR (d.group_id = $group_id AND ($folder_id IS NULL OR (d)-[:IN_FOLDER]->(:Folder {id: $folder_id})))
```

## Neo4j Schema (Already Exists)

From [RESTRUCTURE_COMPLETE_2026-01-31.md](RESTRUCTURE_COMPLETE_2026-01-31.md):

```cypher
-- Folder nodes
CREATE (:Folder {id, name, group_id, parent_id?, created_at, updated_at})

-- Relationships
(:Folder)-[:SUBFOLDER_OF]->(:Folder)  -- max depth = 2
(:Document)-[:IN_FOLDER]->(:Folder)

-- Constraints
CREATE CONSTRAINT folder_id_unique FOR (f:Folder) REQUIRE f.id IS UNIQUE
```

## Usage Example

```python
# API call with folder filtering
GET /chat/completions?folder_id=folder-123
POST /chat/completions
{
    "messages": [...],
    "folder_id": "folder-123"  # Optional
}

# Document assignment
POST /folders/folder-123/documents
{"document_id": "doc-456"}

# Bulk assignment
POST /folders/folder-123/documents/bulk
{"document_ids": ["doc-1", "doc-2", "doc-3"]}
```

## Validation

All modified files pass linting with no errors:
- ✅ chat.py
- ✅ folders.py
- ✅ orchestrator.py
- ✅ base.py (route handler)
- ✅ community_matcher.py
- ✅ hub_extractor.py
- ✅ tracing.py
- ✅ enhanced_graph_retriever.py

## Remaining Work (Future Sessions)

1. **Integration Testing**: Test folder filtering end-to-end with actual Neo4j queries
2. **Remaining EnhancedGraphRetriever methods**: Some entity-focused methods may need review
3. **B2B/B2C Authentication**: Items from yesterday's handover (on hold)

## Previous Handover Items (On Hold)

From HANDOVER_2026-02-02.md:
- B2B JWT flow implementation
- B2C interactive flow verification
- Hybrid auth decorator pattern
- These are deferred pending folder isolation completion

## References

- [RESTRUCTURE_COMPLETE_2026-01-31.md](RESTRUCTURE_COMPLETE_2026-01-31.md) - Folder hierarchy design
- [ARCHITECTURE_PLAN_FULLSTACK_2026-01-30.md](ARCHITECTURE_PLAN_FULLSTACK_2026-01-30.md) - Overall architecture
- [HANDOVER_2026-02-02.md](HANDOVER_2026-02-02.md) - Previous session (B2B/B2C auth todos)
