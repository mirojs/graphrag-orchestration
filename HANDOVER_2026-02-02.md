# GraphRAG Orchestration Handover - February 2, 2026

## Executive Summary

Today's session focused on implementing **dual authentication** for the GraphRAG API:
- **B2B (Entra ID)** - Enterprise authentication with groups-based multi-tenancy
- **B2C (External ID)** - Consumer authentication with user-based isolation

Both container apps are now deployed and operational.

---

## Current Deployment Status

### Infrastructure

| Component | URL | Auth Type | Status |
|-----------|-----|-----------|--------|
| **GraphRAG API (B2B)** | `https://graphrag-api.salmonhill-df6033f3.swedencentral.azurecontainerapps.io` | Entra ID (groups) | ✅ Working |
| **GraphRAG API (B2C)** | `https://graphrag-api-b2c.salmonhill-df6033f3.swedencentral.azurecontainerapps.io` | External ID (oid) | ✅ Deployed |
| **GraphRAG Worker** | Internal only | N/A | ✅ Working |

### Azure Resources

- **Resource Group**: `rg-graphrag-feature`
- **Container Apps Environment**: `graphrag-env` (Sweden Central)
- **Container Registry**: `graphragacr12153.azurecr.io`

### Authentication Configuration

#### B2B (Enterprise - Entra ID)
- **Tenant ID**: `ecaa729a-f04c-4558-a31a-ab714740ee8b`
- **Client ID**: `b68b6881-80ba-4cec-b9dd-bd2232ec8817`
- **App Name**: GraphRAG API - Feature Environment
- **Issuer**: `https://login.microsoftonline.com/{tenant}/v2.0`
- **Partition Strategy**: `groups[0]` claim → `group_id`
- **Fallback**: `GROUP_ID_OVERRIDE=test-5pdfs-v2-fix2` (when groups claim missing)

#### B2C (Consumer - External ID)
- **Tenant Name**: `graphragb2c`
- **Tenant ID**: `aa5210de-5c3a-4383-adbb-13c7998b1be0`
- **Client ID**: `0a8e8140-2f22-4110-bc57-c2316add0b13`
- **App Name**: GraphRAG API - B2C
- **Issuer**: `https://graphragb2c.ciamlogin.com/{tenant}/v2.0`
- **Partition Strategy**: `oid` claim → `user_id` (also used as `group_id`)

---

## Changes Made Today

### 1. Fixed B2B Authentication Bug
- **File**: `src/api_gateway/middleware/auth.py`
- **Issue**: `raise HTTPException` was outside the `else` block, always executing even when `GROUP_ID_OVERRIDE` was set
- **Fix**: Corrected indentation to properly use else blocks for conditional exception raising

### 2. Added External ID (B2C) Support

#### Infrastructure Changes
- **`infra/main.bicep`**: Added B2C parameters and container app module
  - `enableB2C`, `b2cTenantName`, `b2cTenantId`, `b2cClientId`, `b2cClientSecret`
  - New `graphragApiB2C` module deployment

- **`infra/core/host/container-app.bicep`**: Added External ID issuer support
  - `useExternalIdIssuer` and `externalIdTenantName` parameters
  - Dynamic `openIdIssuerUrl` calculation for ciamlogin.com

- **`infra/main.parameters.json`**: Added B2C environment variable mappings

- **`azure.yaml`**: Added `graphrag-api-b2c` service definition

### 3. Created B2C Test Script
- **File**: `scripts/test_b2c_auth.py`
- Interactive MSAL authentication with External ID
- Tests `/health`, `/config`, and `/hybrid/query` endpoints
- Token decoding to show claims

### 4. Cleanup
- Removed old root `Dockerfile` (using `Dockerfile.api` and `Dockerfile.worker`)

---

## How to Test

### B2B Authentication (Entra ID)
```bash
# Get token and test
ACCESS_TOKEN=$(az account get-access-token --resource api://b68b6881-80ba-4cec-b9dd-bd2232ec8817 --query accessToken -o tsv)
curl -H "Authorization: Bearer $ACCESS_TOKEN" \
  https://graphrag-api.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/health
```

### B2C Authentication (External ID)
```bash
# Requires user in External ID tenant
python scripts/test_b2c_auth.py
```

---

## Outstanding TODOs

### High Priority
- [ ] **Create test user in External ID tenant** - Required to test B2C flow
  - Go to Azure Portal → graphragb2c tenant → Users → New user
  - Or enable self-service signup in app registration

- [ ] **Enable public client flows** in B2C app registration
  - graphragb2c tenant → App registrations → GraphRAG API - B2C
  - Authentication → Advanced settings → Allow public client flows = Yes

- [ ] **Test B2C end-to-end** with actual user authentication

### Medium Priority
- [ ] **Configure Azure AD groups** properly for B2B (currently using GROUP_ID_OVERRIDE)
  - Need to emit `groups` claim in tokens
  - Create security groups in Entra ID
  - Assign users to groups

- [ ] **Add user flow** for External ID self-service signup (if consumer-facing)

- [ ] **Frontend integration** - Update frontend MSAL config to support both auth types

### Low Priority
- [ ] **Clean up old benchmark/log files** in repo root
- [ ] **Move handover files** to docs/handover/ directory
- [ ] **Add monitoring/alerting** for both container apps

---

## Key Files Reference

| File | Purpose |
|------|---------|
| `src/api_gateway/middleware/auth.py` | JWT validation, B2B/B2C token handling |
| `src/core/config.py` | Settings including AUTH_TYPE, GROUP_ID_OVERRIDE |
| `infra/main.bicep` | Infrastructure deployment (both B2B and B2C apps) |
| `infra/core/host/container-app.bicep` | Container app module with Easy Auth |
| `azure.yaml` | Service definitions for azd deploy |
| `scripts/test_b2c_auth.py` | External ID authentication test script |

---

## Environment Variables (azd)

```bash
# B2C Configuration (set via azd env set)
ENABLE_B2C=true
B2C_TENANT_NAME=graphragb2c
B2C_TENANT_ID=aa5210de-5c3a-4383-adbb-13c7998b1be0
B2C_CLIENT_ID=0a8e8140-2f22-4110-bc57-c2316add0b13
B2C_CLIENT_SECRET=<stored in azd env - see .azure/feature/.env>
```

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    Azure Container Apps Environment              │
│                         (graphrag-env)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐       ┌─────────────────────┐         │
│  │   graphrag-api      │       │   graphrag-api-b2c  │         │
│  │   (B2B / Entra ID)  │       │   (B2C / External)  │         │
│  ├─────────────────────┤       ├─────────────────────┤         │
│  │ Auth: groups claim  │       │ Auth: oid claim     │         │
│  │ Issuer: login.ms.com│       │ Issuer: ciamlogin   │         │
│  │ Partition: group_id │       │ Partition: user_id  │         │
│  └──────────┬──────────┘       └──────────┬──────────┘         │
│             │                              │                    │
│             └──────────────┬───────────────┘                    │
│                            ▼                                    │
│               ┌─────────────────────────┐                       │
│               │    graphrag-worker      │                       │
│               │  (Background Processing)│                       │
│               └─────────────────────────┘                       │
│                            │                                    │
└────────────────────────────┼────────────────────────────────────┘
                             │
           ┌─────────────────┼─────────────────┐
           ▼                 ▼                 ▼
    ┌───────────┐     ┌───────────┐     ┌───────────┐
    │  Neo4j    │     │ Cosmos DB │     │   Redis   │
    │  (Graph)  │     │  (Chat)   │     │  (Queue)  │
    └───────────┘     └───────────┘     └───────────┘
```

---

## Troubleshooting

### B2B Returns 401
1. Check if token is valid: `az account get-access-token --resource api://b68b6881-80ba-4cec-b9dd-bd2232ec8817`
2. Verify groups claim or GROUP_ID_OVERRIDE is set

### B2C Container Not Responding
1. Check container logs: `az containerapp logs show --name graphrag-api-b2c --resource-group rg-graphrag-feature --type console --tail 50`
2. Verify Easy Auth config: `az containerapp auth show --name graphrag-api-b2c --resource-group rg-graphrag-feature`

### Deployment Issues
1. Rebuild with: `azd deploy graphrag-api-b2c`
2. Check provision: `azd provision`

---

## Next Session Recommendations

1. **Complete B2C testing** - Create user, run test script, verify end-to-end
2. **Configure proper Azure AD groups** for B2B production use
3. **Consider frontend work** - Adapt frontend MSAL to support both auth flows
4. **Document API differences** - B2B vs B2C response handling if any
