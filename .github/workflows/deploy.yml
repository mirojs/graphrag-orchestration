# GraphRAG Orchestration - Build & Deploy Pipeline
#
# Architecture:
#   - 1x API Container (graphrag-api) - handles requests + sync queries
#   - 1x Worker Container (graphrag-worker) - processes async jobs
#   - Both containers share same codebase, just different entry points
#
# Algorithm Version:
#   - Set via DEFAULT_ALGORITHM_VERSION env var on worker
#   - Can be overridden per-request via X-Algorithm-Version header
#   - For testing v3: use preview-worker.sh to deploy preview container
#
# Deployment:
#   - Push to main: auto-deploy to production
#   - Manual: choose algorithm version for worker

name: Build & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Dockerfile*'
      - 'requirements*.txt'
      - 'pyproject.toml'
  workflow_dispatch:
    inputs:
      algorithm_version:
        description: 'Default algorithm version for worker'
        required: true
        default: 'v2'
        type: choice
        options:
          - v1
          - v2
          - v3
      deploy_preview:
        description: 'Also deploy to preview worker (for v3 testing)'
        required: false
        default: false
        type: boolean

# Federated credentials for Azure login
permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-graphrag-feature' }}
  ACR_NAME: ${{ vars.ACR_NAME || 'graphragacr12153' }}
  API_APP_NAME: graphrag-api
  WORKER_APP_NAME: graphrag-worker

jobs:
  # ============================================================================
  # Build - Both containers from same codebase
  # ============================================================================
  
  build:
    name: Build Containers
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}
      
      - name: Set image tag
        id: vars
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAG="${SHORT_SHA}-${{ github.run_number }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $TAG"
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/graphrag-api:${{ steps.vars.outputs.tag }}
            ${{ env.ACR_NAME }}.azurecr.io/graphrag-api:latest
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api
          build-args: |
            GIT_SHA=${{ github.sha }}
            BUILD_NUMBER=${{ github.run_number }}
      
      - name: Build and push Worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/graphrag-worker:${{ steps.vars.outputs.tag }}
            ${{ env.ACR_NAME }}.azurecr.io/graphrag-worker:latest
          cache-from: type=gha,scope=worker
          cache-to: type=gha,mode=max,scope=worker
          build-args: |
            GIT_SHA=${{ github.sha }}
            BUILD_NUMBER=${{ github.run_number }}

  # ============================================================================
  # Deploy to Production
  # ============================================================================
  
  deploy:
    name: Deploy to Production
    needs: [build]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install Azure CLI extensions
        run: az extension add --name containerapp --upgrade --yes
      
      - name: Get current revision (for rollback)
        id: current
        run: |
          CURRENT=$(az containerapp revision list \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?properties.active && properties.trafficWeight > \`0\`].name | [0]" -o tsv 2>/dev/null || echo "")
          echo "revision=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current revision: ${CURRENT:-none}"
      
      - name: Deploy API
        id: deploy_api
        run: |
          IMAGE="${{ env.ACR_NAME }}.azurecr.io/graphrag-api:${{ needs.build.outputs.image_tag }}"
          echo "Deploying API: $IMAGE"
          
          REVISION_SUFFIX="r${{ github.run_id }}"
          az containerapp update \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image "$IMAGE" \
            --revision-suffix "$REVISION_SUFFIX"
          
          # Route 100% traffic to the new revision
          REVISION_NAME="${{ env.API_APP_NAME }}--${REVISION_SUFFIX}"
          echo "Routing traffic to: $REVISION_NAME"
          az containerapp ingress traffic set \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --revision-weight "${REVISION_NAME}=100"
      
      - name: Deploy Worker
        run: |
          IMAGE="${{ env.ACR_NAME }}.azurecr.io/graphrag-worker:${{ needs.build.outputs.image_tag }}"
          ALGO="${{ github.event.inputs.algorithm_version || 'v2' }}"
          echo "Deploying Worker: $IMAGE (DEFAULT_ALGORITHM_VERSION=$ALGO)"
          
          az containerapp update \
            --name ${{ env.WORKER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image "$IMAGE" \
            --revision-suffix "r${{ github.run_id }}" \
            --set-env-vars "DEFAULT_ALGORITHM_VERSION=$ALGO"
      
      - name: Wait for startup
        run: sleep 30
      
      - name: Health check
        id: health
        run: |
          URL=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "Testing: https://$URL"
          TOKEN=$(az account get-access-token --scope api://b68b6881-80ba-4cec-b9dd-bd2232ec8817/.default --query accessToken -o tsv)
          
          for i in {1..5}; do
            HTTP=$(curl -s -o /dev/null -w "%{http_code}" "https://$URL/health" --max-time 10 -H "Authorization: Bearer $TOKEN")
            if [ "$HTTP" == "200" ]; then
              echo "âœ… Health check passed"
              curl -s -I "https://$URL/health" -H "Authorization: Bearer $TOKEN" | grep -i "x-" || true
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP, retrying..."
            sleep 10
          done
          
          echo "âŒ Health check failed"
          exit 1
      
      - name: Rollback on failure
        if: failure() && steps.health.outcome == 'failure'
        run: |
          PREV="${{ steps.current.outputs.revision }}"
          if [ -n "$PREV" ]; then
            echo "ðŸ”„ Rolling back to $PREV"
            az containerapp ingress traffic set \
              --name ${{ env.API_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision-weight "$PREV=100"
          fi
      
      - name: Summary
        if: success()
        run: |
          URL=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          ALGO="${{ github.event.inputs.algorithm_version || 'v2' }}"
          
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://$URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Container | Tag | Algorithm |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | \`${{ needs.build.outputs.image_tag }}\` | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | \`${{ needs.build.outputs.image_tag }}\` | **$ALGO** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Override" >> $GITHUB_STEP_SUMMARY
          echo "Use header \`X-Algorithm-Version: v1|v2|v3\` to override per-request." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Deploy Preview Worker (Optional - for v3 testing)
  # ============================================================================
  
  deploy-preview:
    name: Deploy Preview Worker
    needs: [build]
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_preview == 'true'
    environment: preview
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install Azure CLI extensions
        run: az extension add --name containerapp --upgrade --yes
      
      - name: Get Container App Environment
        id: env
        run: |
          ENV_ID=$(az containerapp show \
            --name ${{ env.WORKER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.environmentId" -o tsv)
          echo "env_id=$ENV_ID" >> $GITHUB_OUTPUT
      
      - name: Deploy or Create Preview Worker
        run: |
          IMAGE="${{ env.ACR_NAME }}.azurecr.io/graphrag-worker:${{ needs.build.outputs.image_tag }}"
          PREVIEW_NAME="${{ env.WORKER_APP_NAME }}-preview"
          ALGO="${{ github.event.inputs.algorithm_version || 'v3' }}"
          
          echo "Deploying preview worker: $IMAGE (DEFAULT_ALGORITHM_VERSION=$ALGO)"
          
          # Check if preview worker exists
          if az containerapp show --name "$PREVIEW_NAME" --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &>/dev/null; then
            # Update existing
            az containerapp update \
              --name "$PREVIEW_NAME" \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --image "$IMAGE" \
              --set-env-vars "DEFAULT_ALGORITHM_VERSION=$ALGO" "ALGORITHM_V3_PREVIEW_ENABLED=true"
          else
            # Create new
            az containerapp create \
              --name "$PREVIEW_NAME" \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --environment "${{ steps.env.outputs.env_id }}" \
              --image "$IMAGE" \
              --ingress internal \
              --target-port 8000 \
              --cpu 1 --memory 2Gi \
              --min-replicas 1 --max-replicas 1 \
              --env-vars "DEFAULT_ALGORITHM_VERSION=$ALGO" "ALGORITHM_V3_PREVIEW_ENABLED=true"
          fi
      
      - name: Preview Summary
        run: |
          ALGO="${{ github.event.inputs.algorithm_version || 'v3' }}"
          
          echo "## ðŸ§ª Preview Worker Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | Algorithm |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| graphrag-worker | v2 (production) |" >> $GITHUB_STEP_SUMMARY
          echo "| graphrag-worker-preview | **$ALGO** (testing) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Enable Routing" >> $GITHUB_STEP_SUMMARY
          echo "Set on API container:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "WORKER_PREVIEW_URL=http://graphrag-worker-preview" >> $GITHUB_STEP_SUMMARY
          echo "ALGORITHM_V3_PREVIEW_ENABLED=true" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
