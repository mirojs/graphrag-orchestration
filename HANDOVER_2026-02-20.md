# Handover — 2026-02-20

## Session Goal

Restore Q-D8 (cross-document entity comparison: "which entity appears in more documents — Fabrikam Inc. or Contoso Ltd.?") from a 0/3 regression back to 3/3, without regressing the rest of the 54/57 baseline.

---

## What Was Done Today

Four layered fixes were implemented, benchmarked, and committed as `3081e6e`.

### Fix A — `route_5_unified.py`: `_denoise_sentences()` structured-source bypass

**Problem:** The boilerplate regex `r"(?i)(signature|signed this|print\)|registration number|authorized representative)"` was hard-deleting `signature_party` sentences before reranking. These are curated at index time and contain the exact entity-role evidence Q-D8 needs.

**Fix:** Added a `_STRUCTURED_SOURCES = {"signature_party", "table_row", "figure_caption"}` bypass — these sentences skip all content-heuristic filters (HTML-heavy, too-short, boilerplate, bare-heading). Only residual HTML is stripped.

**File:** `src/worker/hybrid_v2/routes/route_5_unified.py` — `_denoise_sentences()` method.

---

### Fix B — `seed_resolver.py`: `resolve_signatureblock_entities()` for Tier 2

**Problem:** `SignatureBlock` content is stored as `Sentence{source="signature_party"}` nodes, not `Section` nodes. The Tier 2 structural seed path (`Section ← IN_SECTION ← TextChunk → MENTIONS → Entity`) was completely blind to contracting-party entities.

**Fix:** New function `resolve_signatureblock_entities()` queries `(:Sentence {source="signature_party", group_id})-[:MENTIONS]->(e:Entity)` directly. Wired into both `_resolve_tier2()` (in `resolve_all_tiers()`) and `_resolve_structural_addon()` (in `resolve_flat_seed_pool()`), running in parallel with `resolve_section_entities()` via `asyncio.gather`.

**File:** `src/worker/hybrid_v2/pipeline/seed_resolver.py`.

---

### Fix C — `chunk_filters.py`: `_FILLED_LABEL_RE` min-content exemption

**Problem:** `_min_content_penalty` was applying a 0.20 multiplier to any chunk with fewer than ~200 characters. Short signature-block pages (e.g. "Authorized Representative: Contoso Ltd." — ~35 tokens) were penalised 80%, sinking them below the synthesis budget cutoff.

**Fix:** Added `_FILLED_LABEL_RE = re.compile(r"[A-Za-z][A-Za-z0-9 /\-()']+:\s*[A-Za-z0-9]", re.MULTILINE)`. Short chunks that match at least one filled `Label: Value` line are exempted from the penalty. The regex intentionally uses `[A-Za-z0-9]` (not `\w`) so blank labels like "Name: ___________" are NOT falsely exempted.

**File:** `src/worker/hybrid_v2/pipeline/chunk_filters.py`.

---

### Fix D — `text_store.py`: signature block chunk injection

**Problem:** The main Cypher in `_get_chunks_for_entities_batch_sync()` orders chunks globally by `chunk_index ASC` then takes `collect()[0..$limit=12]`. Exhibit A signature pages have `chunk_index ≈ 21` (they appear at the end of the purchase_contract). Chunks from other documents with `chunk_index 0–11` always fill the 12-slot limit first, so Exhibit A is never retrieved.

**Fix:** After the main per-entity loop, a supplementary Cypher query traverses `(:Sentence {source="signature_party"})-[:MENTIONS]->(e)` then `(s)-[:PART_OF]->(c:TextChunk)` to find TextChunks that carry entity-bearing signature sentences. These chunks are **prepended** (`.insert(0, ...)`) so they appear at position 0 in the entity's chunk list and survive the synthesis `[:budget]` slice (DEFAULT_LIMIT=12 in `synthesis.py`).

**File:** `src/worker/hybrid_v2/indexing/text_store.py` — `_get_chunks_for_entities_batch_sync()`.

---

## Benchmark Results

| Run | Score | Q-D3 | Q-D5 | Q-D8 | Notes |
|-----|-------|------|------|------|-------|
| fix9 (pre-session baseline) | 54/57 (94.7%) | 3/3 | 3/3 | 0/3 | Q-D8 regressed |
| Today — targeted Q-D8 only | — | — | — | **3/3** | All 4 fixes in place |
| Today — full 19-question run | 53/57 (93.0%) | 2/3 | 2/3 | 1/3 | See regression note |

**Score interpretation:** 57 = 19 questions × 3 runs each. Each question score is the LLM-judge sum across 3 independent runs.

---

## Open Regression: Q-D3 and Q-D5 dropped 3/3 → 2/3

### What changed

| Q | fix9 | today full-run | delta |
|---|------|---------------|-------|
| Q-D3 (all time windows) | 3/3 | 2/3 | **-1** |
| Q-D5 (warranty coverage period) | 3/3 | 2/3 | **-1** |
| Q-D8 (entity doc-count comparison) | 0/3 | 1/3 | +1 |
| **Total** | **54** | **53** | **-1** |

This is not LLM temperature noise — 57 points is already a 3-run average, so a 3/3 → 2/3 drop means one of the three runs now consistently fails.

### Suspected root cause: Fix D displacement

Fix D prepends signature-block TextChunks at position 0 for every entity that appears in a `signature_party` sentence. "Fabrikam Inc." and "Contoso Ltd." appear in signature blocks across multiple documents. This means for those entities, position 0 (and possibly 1–2) in their chunk list is now a signature page rather than a warranty/PM-agreement body chunk.

Q-D3 asks for **all time windows across all documents** — it needs warranty body text (60/90/180-day clauses), PM agreement text (12-month/60-day/180-day/5-business-day items), and purchase contract text (3-business-day cancellation, 90-day labor warranty). If those chunks are displaced from the synthesis budget by signature pages, timeframes get dropped from the answer.

Q-D5 asks about warranty coverage start/end — also warranty-body dependent.

### Alternative suspect: Fix B seed dilution

Adding all contracting-party entities (from `signature_party` sentences) to the Tier 2 PPR seed set increases seed count. More seeds → smaller per-seed weight → PPR may spread more broadly and return less warranty-section-specific entities. This could dilute the chunk pool for warranty/PM content.

---

## TODO for Tomorrow

### P0 — Fix the regression on Q-D3 and Q-D5

1. **Confirm the displacement hypothesis for Fix D.**
   - Run Q-D3 standalone with `--filter-qid Q-D3` and add debug logging (or inspect the raw JSON output) to check what chunks are actually in the synthesis context for entities like "warranty period", "arbitration", "Fabrikam", "Contoso".
   - If signature pages are at positions 0–2 and warranty body chunks are at positions 12+, Fix D is the cause.

2. **Candidate fix: limit sig-block injection to entities with zero non-sig-block chunks, or cap injection at 1 per entity.**
   - Current: `results.setdefault(entity_name, []).insert(0, ...)` — injects one chunk per signature occurrence, potentially inserting many for cross-document contracting parties.
   - Better heuristic: only inject if the entity has fewer than `N` chunks from the main query (sig-block injection as a true gap-fill, not a boost for already-well-represented entities).
   - Or: inject at the end (append) rather than prepend, and separately ensure synthesis budget is entity-scoped not pool-scoped so sig chunks for one entity don't crowd out body chunks for another.

3. **Check if Q-D8 is now consistently 3/3 or still variable.**
   - If Fix D is needed for Q-D8 but causes D3/D5 regression, the injection strategy needs refinement rather than removal.
   - Run `--filter-qid Q-D8` again (3 repeats) to confirm it's reliably passing.

### P1 — Understand Q-D8 full-run variability (1/3 vs 3/3)

Even in the "fixed" state, Q-D8 only scored 1/3 in the full run vs 3/3 in the targeted run. This suggests the synthesis context for Q-D8 is still fragile — it's correct sometimes but not reliably. The signature chunk injection helps but the evidence may still be on the edge of the synthesis budget in some runs.

### P2 — Evaluate Fix B seed dilution impact

Check if reducing the `resolve_signatureblock_entities()` entity set (e.g., by scoping to only the folder in use, or capping) improves Q-D3/Q-D5 without hurting Q-D8.

---

## HippoRAG Implementation Note

### What version is in use?

The codebase is architected around **HippoRAG 2 concepts** but uses a **fully custom LlamaIndex-native implementation** — the upstream `hipporag` pip package is commented out in `requirements.txt` and never installed:

```
# hipporag>=0.1.0  # Optional - not used in current LlamaIndex-native implementation
```

The production retrieval path lives in `src/worker/hybrid_v2/retrievers/hipporag_retriever.py`.

### Why this matters: v2 seed reliability

HippoRAG 1 used simple named-entity extraction to find PPR seeds (typically a single LLM NER pass). HippoRAG 2 introduced a richer, multi-strategy seed resolution approach. Our custom implementation follows the v2 design with **6 seed resolution strategies**, applied in order:

| Strategy | Description |
|----------|-------------|
| Exact match | `toLower(e.name) = toLower(seed)` |
| Alias match | Checks `e.aliases[]` list |
| KVP key match | Matches key-value pair nodes by key |
| Substring match | Seed string contained within entity name |
| Jaccard similarity | Token overlap above threshold |
| Vector similarity | Falls back to `entity_embedding_v2` Neo4j index |

This multi-strategy resolution means seeds are far less likely to be silently dropped when entity names have minor variations (abbreviations, punctuation, case differences). HippoRAG 1's single-strategy NER seeding would miss "Contoso Ltd." if the query mentioned "Contoso" — the v2 substring/alias strategies catch it.

The PPR algorithm itself: power iteration with damping=0.85, max_iter=20, seeded from the resolved entity node set. Graph is loaded from Neo4j into in-memory adjacency lists at retrieval time.

### Initialization priority in `HippoRAGService`

1. **Custom `HippoRAGRetriever`** — always active (LlamaIndex-native, Neo4j-backed)
2. Upstream `hipporag.HippoRAG` — dead code, package not installed
3. `_LocalPPRHippoRAG` — last-resort pure-Python fallback over JSON triples

### Relevant files

| File | Purpose |
|------|---------|
| `src/worker/hybrid_v2/retrievers/hipporag_retriever.py` | Core PPR retriever, 6-strategy seed resolution |
| `src/worker/hybrid_v2/indexing/hipporag_service.py` | Service wrapper, 3-tier initialization |
| `src/worker/hybrid_v2/pipeline/seed_resolver.py` | Upstream seed extraction (Tier 1/2/3) fed into PPR |

---

## Relevant File Locations

| File | Purpose |
|------|---------|
| `src/worker/hybrid_v2/routes/route_5_unified.py` | Route 5 execute(), `_denoise_sentences()` |
| `src/worker/hybrid_v2/pipeline/seed_resolver.py` | Tier 2 seed resolution, `resolve_signatureblock_entities()` |
| `src/worker/hybrid_v2/pipeline/chunk_filters.py` | Noise penalty filters, `_FILLED_LABEL_RE` |
| `src/worker/hybrid_v2/indexing/text_store.py` | Chunk retrieval, signature block injection |
| `src/worker/hybrid_v2/synthesis/synthesis.py` | Entity budget (`DEFAULT_LIMIT=12`) |
| `benchmarks/route5_unified_r4questions_20260220T183022Z.eval.md` | Today's full-run LLM judge report (53/57) |
| `benchmarks/route5_unified_r4questions_20260220T182708Z.eval.md` | Today's targeted Q-D8 run (3/3) |

---

## Key Graph Schema Facts (confirmed)

- Signature evidence: `(:Sentence {source: "signature_party", group_id})`
- Sentence → entity: `(:Sentence)-[:MENTIONS]->(e:Entity)`
- Sentence → chunk: `(:Sentence)-[:PART_OF]->(c:TextChunk)`
- Chunk → document: `(:TextChunk)-[:IN_DOCUMENT]->(d:Document)`
- Entity → document: `(:Entity)-[:APPEARS_IN_DOCUMENT]->(d:Document)` (4,522 edges in test corpus)
- Synthesis budget: `DEFAULT_LIMIT = 12` chunks per entity in `synthesis.py`
