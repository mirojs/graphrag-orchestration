# Handover - February 7, 2026

## Summary

Today's session focused on **Route 4 DRIFT** improvements and **Router LLM** prompt refinements.

---

## Completed Work

### 1. Route 4 Ground Truth Expansion (14 → 16 + 2 observations)

**File:** `scripts/test_route4_comprehensive_sentence.py`

- Added **B6**: Automatic opener vs door operator terminology
- Added **B7**: Power system (contract) vs operation parts (invoice) — confirmed REAL via Neo4j Table nodes
- Added **D-category** "Observations" (not strict inconsistencies but demonstrate analytical depth):
  - **D1**: Tax field N/A on invoice (Table row: SUBTOTAL→TAX, 29900.00→N/A)
  - **D2**: Entity role variation (Contoso Ltd=Owner in warranty/tank/property-mgmt vs Contoso Lifts LLC=Contractor in invoice/contract)

**Commits:**
- `4a7cddc1` scoring: add B7 power-system/operation-parts (16 GT items)
- `377821b9` scoring: add D-category observations (Tax N/A, Role Swaps)

**All 3 synthesis models score 18/18** (16 core + 2 obs):
- gpt-5.1: 18/18
- gpt-4.1: 18/18
- gpt-4.1-mini: 18/18

### 2. DRIFT Decomposition Multi-line Parser Fix

**Previous commits (from earlier session):**
- Fixed `_drift_decompose()` to properly handle multi-line sub-questions
- Added BAD/GOOD examples to prompt for complete self-contained sentences
- Seeds jumped from 0-13 → 13-18 after fix

### 3. Route 4 Synthesis Markdown Formatting

**Commit:** `cdadfd94` refactor: standardize all LLM outputs to markdown format

- Updated synthesis prompts to output structured markdown
- Entity discovery improved: 13-18 seeds (plain) → **196 seeds** (markdown)
- Response quality: Clean hierarchical sections with proper formatting

**Commit:** `68652b0a` fix: restore synthesis prompt instructions lost in markdown refactor

### 4. Router LLM Prompt Refinements

**File:** `src/worker/hybrid_v2/router/main.py`

Fixed 2 misclassifications:
- **Q-V4**: "List the 3 installment amounts" → now routes to **local_search** (was drift, 10-80s penalty)
- **Q-N6**: "Which documents governed by CA?" → now routes to **local_search** (was global, 25-40s)

Changes made:
- Added "Lists of specific items within a document" to local_search
- Added "Simple document identification by explicit mentions" to local_search
- Restricted drift trigger: "which document" only for **calculated conditions, ranking, or cross-referencing**
- Added critical distinction: `"Which contracts are in NY?" (local)` vs `"Which contract has the best payment terms?" (drift)`

**Note:** Router changes are uncommitted pending testing.

### 5. Route 4 Benchmark Run

**File:** `benchmarks/route4_drift_multi_hop_20260207T141414Z.json`

19 questions × 3 repeats:

| Metric | Value |
|--------|-------|
| Positive Tests Passed | 6/10 (containment ≥ 0.5) |
| Negative Tests Passed | 8/9 |
| Avg Containment | 0.54 |
| Avg F1 | 0.11 |
| Latency P50 | 38.6s |
| Latency P95 | 134.4s |

**Passed:** Q-D1, Q-D2, Q-D3, Q-D4, Q-D6, Q-D8

**Failed positive tests:**
- Q-D5: 0.00 containment
- Q-D7: 0.22 containment (0.4s latency - suspiciously fast, may have errored)
- Q-D9: 0.00 containment
- Q-D10: 0.00 containment

**Failed negative test:**
- Q-N7: Should have returned "not found" but didn't

---

## Open TODOs

### High Priority

1. **Investigate Q-D5, Q-D7, Q-D9, Q-D10 failures**
   - Check if ground truth is accurate
   - Verify retrieval is finding relevant chunks
   - Q-D7 had 0.4s latency — may be a timeout/error, not a real answer

2. **Investigate Q-N7 failure**
   - This is a negative test that should return "not found"
   - Verify the question and expected behavior

3. **Commit router prompt changes**
   - File: `src/worker/hybrid_v2/router/main.py`
   - Test Q-V4 and Q-N6 routing before committing

### Medium Priority

4. **Re-run router benchmark** to verify Q-V4 and Q-N6 now route correctly

5. **Consider adding more observations to D-category** if models consistently surface other real cross-document insights

### Low Priority

6. **Latency optimization** — P95 is 134.4s, some queries take 150s+

---

## Key Files Modified Today

| File | Status | Description |
|------|--------|-------------|
| `scripts/test_route4_comprehensive_sentence.py` | ✅ Committed | 16+2 GT scoring |
| `src/worker/hybrid_v2/router/main.py` | ⚠️ Uncommitted | Q-V4/Q-N6 fix |
| `benchmarks/route4_drift_multi_hop_20260207T141414Z.json` | New | Route 4 benchmark |
| `benchmarks/route4_drift_multi_hop_20260207T141414Z.md` | New | Route 4 benchmark report |

---

## Neo4j Credentials (for verification queries)

```
URI: neo4j+s://a86dcf63.databases.neo4j.io
User: neo4j
Password: uvRJoWeYwAu7ouvN25427WjGnU37oMWaKN_XMN4ySKI
Database: neo4j
```

**Group ID:** `test-5pdfs-v2-fix2`

---

## Recent Commits

```
68652b0a fix: restore synthesis prompt instructions lost in cdadfd94 markdown refactor
7eee442d Add benchmark postfix results 2026-02-07
cdadfd94 refactor: standardize all LLM outputs to markdown format
2aebf944 router: upgrade to gpt-5.1 for 97.6% accuracy (from 92.7%)
cb80c94d fix(route3): always run coverage gap fill for global search
377821b9 scoring: add D-category observations (Tax N/A, Role Swaps)
4a7cddc1 scoring: add B7 power-system/operation-parts (16 GT items)
```

---

## Quick Resume Commands

```bash
# Check uncommitted changes
cd /afh/projects/graphrag-orchestration && git status

# Run Route 4 comprehensive test (18/18 scoring)
python3 scripts/test_route4_comprehensive_sentence.py

# Run Route 4 benchmark (3 repeats, full question bank)
python3 scripts/benchmark_route4_drift_multi_hop.py --repeats 3

# Check specific failing question (e.g., Q-D5)
python3 scripts/benchmark_route4_drift_multi_hop.py --repeats 1 --filter-qid Q-D5
```
