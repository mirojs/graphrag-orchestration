=== Route 3 Benchmark Results - Document Grouping Fix ===
Date: January 21, 2026
Deployment: main-678988a-20260121062040
Test Group: test-5pdfs-1768557493369886422

KEY ACHIEVEMENT: Q-G10 Document Grouping Fix
----------------------------------------------
✅ All 3 runs return exactly 5 document summaries (matching the 5 Document nodes in graph)
✅ Documents correctly grouped:
   1. BUILDERS LIMITED WARRANTY WITH ARBITRATION
   2. HOLDING TANK SERVICING CONTRACT  
   3. PURCHASE CONTRACT (with Exhibit A merged correctly)
   4. PROPERTY MANAGEMENT AGREEMENT
   5. Contoso Lifts Invoice

Previous behavior: 6-8 summaries (Exhibit A counted separately)
Fixed behavior: 5 summaries (Exhibit A merged with Purchase Contract)

Overall Route 3 Performance (19 questions, 3 repeats each):
------------------------------------------------------------
Positive Questions (Q-G1 to Q-G10):
- 100% thematic coverage on ALL questions (7/7, 6/6, 8/8, etc.)
- Containment scores: 0.61 to 1.00 (avg ~0.80)
- Citation stability: 100% (cite_jacc_min=1.00 for most)
- Evidence path stability: 100% (path_jacc_min=1.00)
- Response times: 9-43 seconds (p50)

Negative Questions (Q-N1, Q-N2, Q-N3, Q-N5 to Q-N10):
- 9/9 PASS (100% negative detection)
- Perfect determinism (exact=1.00, min_sim=1.00)
- Fast refusal: 5-11 seconds (p50)

Technical Implementation:
-------------------------
1. text_store.py: Extract document_id from Document node via PART_OF
2. synthesis.py (Route 2): Group chunks by document_id in _build_cited_context
3. synthesis.py (Route 3): Group chunks by document_id in synthesize_with_graph_context
4. Added "=== DOCUMENT: {title} ===" headers to context for LLM clarity
5. Added debug logging: route3_document_grouping

Impact:
-------
- Fixes Q-G10 over-segmentation (8→5 summaries)
- Improves document-level reasoning across all queries
- Ensures LLM respects graph's document structure (ground truth)
- Better citation attribution with document field in citation_map
