# Handover Document - Q-D7 Date Query Fix
**Date:** 2026-01-16  
**Status:** Partial deployment, code ready but not deployed to production

---

## Executive Summary

**Objective:** Fix Q-D7 benchmark question "Which document has the latest explicit date, and what is it?"
- **Expected Answer:** Purchase Contract (2025-04-30)
- **Current Behavior:** Inconsistent - sometimes returns Holding Tank Contract (2024-06-15), sometimes correct
- **Root Cause:** LLM date parsing/reasoning errors in synthesis stage
- **Solution Implemented:** Deterministic date query detection with direct graph metadata queries

**Current Status:**
- âœ… Code implemented and tested locally
- âœ… Committed to GitHub (commits: e9a6f54, 3dcfb92)
- âŒ **NOT YET DEPLOYED** to Azure Container Apps
- âš ï¸ Benchmark shows improvement but still inconsistent (56% containment)

---

## Problem Analysis

### Discovery Timeline

1. **Initial Hypothesis:** Semantic coverage not retrieving date chunks
   - **Finding:** Coverage WAS working - chunk_39 with "Signed this 04/30/2025" retrieved (similarity 0.6238)

2. **Metadata Bug:** `coverage_metadata["strategy"]` field being overwritten at line 3625
   - **Fix Applied:** Preserve strategy field when rebuilding coverage_metadata dict
   - **Impact:** Improved metadata reporting, slight improvement in LLM reasoning

3. **Real Root Cause:** LLM synthesizing wrong date from retrieved context
   - Neo4j graph has correct Document.date properties (2025-04-30 for purchase contract)
   - LLM seeing both dates but choosing wrong one during synthesis
   - Date parsing/reasoning is unreliable at synthesis stage

4. **Solution:** Deterministic date queries
   - Detect date metadata queries at Stage 4.0 (before retrieval)
   - Query Document.date directly from graph
   - Return deterministic answer without LLM synthesis

---

## Technical Implementation

### Code Changes

**File:** `app/hybrid/pipeline/enhanced_graph_retriever.py`

**Added Components:**
1. **Detection Patterns** (lines ~35-46):
```python
_DATE_METADATA_PATTERNS = [
    re.compile(r'\blatest\s+(?:explicit\s+)?date\b', re.IGNORECASE),
    re.compile(r'\bmost\s+recent\s+date\b', re.IGNORECASE),
    # ... 8 patterns total
]
```

2. **Detection Method** (lines ~201-244):
```python
@staticmethod
def detect_date_metadata_query(query: str) -> Optional[str]:
    """Returns 'latest', 'oldest', or None"""
```

3. **Graph Query Method** (lines ~1643-1713):
```python
async def get_documents_by_date(
    self, order: str = "latest", limit: int = 5
) -> List[Dict[str, Any]]:
    """Query Document.date directly from Neo4j"""
```

**File:** `app/hybrid/orchestrator.py`

**Added Stage 4.0** (lines ~3413-3463):
```python
# Stage 4.0: Deterministic metadata queries (dates)
date_query_type = EnhancedGraphRetriever.detect_date_metadata_query(query)
if date_query_type:
    logger.info(f"ðŸŽ¯ stage_4.0_date_metadata_query_detected", 
                extra={"date_query_type": date_query_type})
    # Query graph, build deterministic response, return early
```

**Fixed Bug** (line ~3676):
- Preserved `strategy` field when rebuilding coverage_metadata dict

---

## Testing Results

### Local Testing âœ…
- Detection test: 8/8 test cases passed
- Neo4j query: Confirmed Document.date = 2025-04-30 for purchase contract
- Semantic coverage: Chunk_39 correctly retrieved with 0.6238 similarity

### Benchmark Results (Current Deployment) âš ï¸
**Timestamp:** 2026-01-16T14:59:13Z  
**File:** `benchmarks/route4_drift_multi_hop_20260116T145913Z.md`

**Q-D7 Metrics:**
- Containment: 0.56 (improved from previous)
- F1 Score: 0.04 (still low)
- Latency P50: 17580ms

**Sample Responses:**
- Run 1: âœ… Found "Untitled (Date: 2025-04-30)" as latest
- Run 2: âŒ Listed "2010-06-15" dates (confused by metadata dates)
- Run 3: Not fully analyzed

**Conclusion:** LLM synthesis still unreliable, deterministic solution needed

---

## Deployment Status

### What's Committed
```bash
Commit: 3dcfb92 (most recent)
Branch: main
Remote: mirojs/graphrag-orchestration
Status: Pushed to GitHub âœ…
```

### What's NOT Deployed
**Azure Container Apps:**
- App Name: `graphrag-orchestration`
- Resource Group: `rg-graphrag-orchestration`
- Current Revision: `graphrag-orchestration--w4kqlju` (OLD)
- Environment: `salmonhill-df6033f3` (Sweden Central)

**Why Not Deployed:**
- No GitHub Actions CI/CD workflow exists
- Manual `az containerapp up` command was initiated but cancelled by user
- Container still running old code (no Stage 4.0 execution in logs)

### Production Evidence
API Test Results:
```json
{
  "deterministic_answer": false,
  "metadata": {"coverage_metadata": {"strategy": "semantic"}}
}
```
- No "stage_4.0" logs found
- No "date_query_type" logs found
- LLM synthesis still running for date queries

---

## Known Issues

### Issue 1: create_date Property Warning âš ï¸

**Timestamp:** 2026-01-16T15:17:34.800831414Z

**Error Message:**
```
Received notification from DBMS server: 
warn: property key does not exist. 
The property `create_date` does not exist in database `neo4j`. 
Verify that the spelling is correct.
```

**Context:**
Query in `get_documents_by_date()` attempts to order by:
```cypher
ORDER BY coalesce(d.create_date, d.date, '') DESC
```

**Impact:**
- Warning only (non-breaking)
- Query falls back to `d.date` which exists
- All 5 documents returned successfully

**Resolution Options:**
1. Remove `d.create_date` from query (only use `d.date`)
2. Add `create_date` property during document indexing
3. Ignore warning if fallback works correctly

**Recommendation:** Option 1 - simplify query to only use `d.date`

### Issue 2: Inconsistent Metadata Dates

**Observation:** Neo4j query results show Document node metadata dates:
```
Untitled (Date: 2010-06-15) - warranty
Untitled (Date: 2010-06-15) - property management
Untitled (Date: 2025-04-30) - purchase contract âœ“
Untitled (Date: 2024-06-15) - holding tank contract
Untitled (Date: 2015-12-17) - invoice
```

**Problem:** Some dates are clearly wrong (2010 for warranty signed 2025-04-30)

**Cause:** Possible confusion between:
- Document signature date (actual date in content)
- Document metadata date (file creation date? indexing date?)

**Impact on Q-D7:**
- LLM seeing conflicting dates in metadata vs content
- When Stage 4.0 deploys, will use Document.date which may be wrong for some docs

**Resolution Needed:**
- Audit document indexing pipeline
- Clarify date field semantics
- Validate all Document.date values match signature/effective dates

---

## Next Steps

### Immediate (P0)

1. **Deploy Deterministic Solution**
   - [ ] Option A: Manual deployment
     ```bash
     cd /afh/projects/graphrag-orchestration
     az containerapp up \
       --source . \
       --name graphrag-orchestration \
       --resource-group rg-graphrag-orchestration \
       --environment salmonhill-df6033f3 \
       --location swedencentral \
       --ingress external \
       --target-port 8000
     ```
   - [ ] Option B: Set up GitHub Actions workflow (`.github/workflows/deploy.yml`)

2. **Validate Deployment**
   - [ ] Test with `/tmp/test_date_query_live.py`
   - [ ] Verify `deterministic_answer: true` in response
   - [ ] Check logs for `stage_4.0_date_metadata_query_detected`
   - [ ] Confirm response shows "2025-04-30"

3. **Re-run Benchmark**
   - [ ] Execute: `python scripts/benchmark_route4_drift_multi_hop.py`
   - [ ] Target Q-D7: Containment > 0.90, F1 > 0.50
   - [ ] Verify coverage_metadata.strategy preserved

### Short-term (P1)

4. **Fix create_date Warning**
   - [ ] Remove `d.create_date` from Cypher query
   - [ ] Test query without warning
   - [ ] Update documentation

5. **Audit Document Dates**
   - [ ] Query all Document.date values in Neo4j
   - [ ] Compare with document content (signature dates)
   - [ ] Identify and fix inconsistent dates
   - [ ] Document date field semantics

6. **Extend Deterministic Queries**
   - [ ] Add "oldest document" queries
   - [ ] Add document count queries
   - [ ] Add other metadata queries (summary, entity counts, etc.)

### Long-term (P2)

7. **CI/CD Setup**
   - [ ] Create `.github/workflows/deploy.yml`
   - [ ] Configure Azure credentials as GitHub secrets
   - [ ] Add deployment triggers (push to main, manual dispatch)

8. **Enhanced Testing**
   - [ ] Add unit tests for detection logic
   - [ ] Add integration tests for deterministic queries
   - [ ] Expand benchmark coverage for metadata queries

---

## Key Files & Resources

### Code Files
- `app/hybrid/orchestrator.py` (lines 3413-3463, 3676)
- `app/hybrid/pipeline/enhanced_graph_retriever.py` (lines 35-46, 201-244, 1643-1713)

### Test Scripts (temporary)
- `/tmp/test_date_detection.py` - validates detection logic
- `/tmp/test_date_query_live.py` - tests production API
- `/tmp/test_semantic_date_query.py` - tests semantic coverage
- `/tmp/check_date_chunks.py` - queries Neo4j for date chunks

### Benchmark Results
- `benchmarks/route4_drift_multi_hop_20260116T145913Z.md` (most recent)
- `bench_route4_current_20260116_145913.txt` (terminal output)

### Azure Resources
- **API URL:** `https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io`
- **Resource Group:** `rg-graphrag-orchestration`
- **App Name:** `graphrag-orchestration`
- **Environment:** `salmonhill-df6033f3`

### Neo4j Database
- **Primary URI:** `neo4j+s://a86dcf63.databases.neo4j.io`
- **Secondary URI:** `neo4j+s://72d67c36.databases.neo4j.io`
- **Group ID:** `test-5pdfs-1768557493369886422`

### Git Repository
- **Remote:** `mirojs/graphrag-orchestration`
- **Branch:** `main`
- **Latest Commit:** `3dcfb92` (debug logging added)
- **Previous Commit:** `e9a6f54` (deterministic solution)

---

## Decision Points for Tomorrow

1. **Deployment Method:**
   - Manual `az containerapp up` (fast, one-time)
   - GitHub Actions (proper, repeatable, takes setup time)

2. **Date Field Strategy:**
   - Use only `d.date` (simplest, current data)
   - Fix all Document.date values first (correct but time-consuming)
   - Add `create_date` during indexing (future-proof)

3. **Scope of Deterministic Queries:**
   - Focus on date queries only (minimal, targeted)
   - Expand to all metadata queries (comprehensive)

4. **Issue Priority:**
   - Fix `create_date` warning immediately (cosmetic)
   - Audit date inconsistencies first (data quality)
   - Deploy and validate first, fix issues later (pragmatic)

---

## Contact & Context

**Session Context:**
- User prefers deterministic approach over LLM enhancement
- User chose "Option B and C" (deploy + continue with current)
- User cancelled manual deployment command mid-execution
- User requested handover document for continuation tomorrow

**Technical Preferences:**
- Deterministic graph queries over LLM reasoning for metadata
- Direct Cypher queries for structured data
- Preserve existing semantic coverage for unstructured queries

**Success Criteria:**
- Q-D7 consistently returns "Purchase Contract (2025-04-30)"
- Benchmark metrics: Containment > 0.90, F1 > 0.50
- No regression in other benchmark questions
- coverage_metadata.strategy field preserved

---

## Quick Start for Tomorrow

```bash
# 1. Navigate to project
cd /afh/projects/graphrag-orchestration

# 2. Activate environment
source .venv/bin/activate

# 3. Check current deployment status
az containerapp show \
  --name graphrag-orchestration \
  --resource-group rg-graphrag-orchestration \
  --query 'properties.latestRevisionName'

# 4. Deploy (if not done)
az containerapp up \
  --source . \
  --name graphrag-orchestration \
  --resource-group rg-graphrag-orchestration \
  --environment salmonhill-df6033f3

# 5. Test deployment
python /tmp/test_date_query_live.py

# 6. Run benchmark
python scripts/benchmark_route4_drift_multi_hop.py
```

---

**Last Updated:** 2026-01-16 (end of day)  
**Next Session:** 2026-01-17
