# GraphRAG Orchestration - Project Handover
**Date:** January 15, 2026  
**Session Focus:** HippoRAG 2 Deployment & Zero Edges Investigation

---

## Current Status

### Deployment State
- **Active Revision:** 0000220 (deployment in progress)
- **Container App:** graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io
- **Latest Commits:**
  - `35fa4af`: Fix Neo4jStore import to Neo4jStoreV3 in debug endpoint
  - `082cfc0`: Add debug endpoint for section similarity distribution
  - `9511973`: Initial HippoRAG 2 implementation (SEMANTICALLY_SIMILAR edges + Confidence Loop)

### Active Investigation
**Problem:** Zero semantic_similarity_edges created despite 51 section embeddings indexed

**Test Group:** `test-5pdfs-1768486622652179443`
- Documents: 5 PDFs (warranty, property mgmt, holding tank, purchase, invoice)
- Indexing Time: 545 seconds (~9 minutes)
- Results:
  - ✅ Section embeddings created: **51**
  - ❌ SEMANTICALLY_SIMILAR edges: **0**
  - ✅ HippoRAG sync complete: 401 entities, 725 triples, 74 text units

**Root Cause Hypotheses:**
1. **Parameter Issue (Most Likely):** `similarity_threshold = 0.80` may be too high for heterogeneous 5-PDF corpus
2. **Code Issue (Less Likely):** Logic error in `_build_section_similarity_edges()` method

---

## HippoRAG 2 Implementation

### Features Deployed
1. **Section Embeddings**
   - Location: `lazygraphrag_pipeline.py:_embed_section_nodes()` (lines 1293-1363)
   - Creates embeddings from: title + path + chunk samples (up to 3 chunks, 500 chars each)
   - Status: ✅ Working (51 embeddings created)

2. **SEMANTICALLY_SIMILAR Edges**
   - Location: `lazygraphrag_pipeline.py:_build_section_similarity_edges()` (lines 1365-1493)
   - Cross-document edges with `threshold=0.80`, `max_edges_per_section=5`
   - Status: ❌ Returned 0 edges (under investigation)

3. **Confidence Loop (Route 4)**
   - Location: `hybrid.py:route4_deep_reasoning_rewrite()` (line 973)
   - Re-decomposes query when confidence < 0.5
   - Status: ⏳ Not yet tested (blocked by edge creation issue)

### Model Configuration
- **GPT-5.1** (2025-11-13, DataZoneStandard): synthesis, NER, intermediate tasks
- **gpt-4.1**: decomposition
- **gpt-4o-mini**: routing

---

## Debug Endpoint Created

### Purpose
Analyze cross-document section similarity distribution to determine if threshold 0.80 is too conservative

### Endpoint Details
- **URL:** `/hybrid/debug/section_similarity_distribution`
- **Header:** `X-Group-ID: test-5pdfs-1768486622652179443`
- **Code Location:** `hybrid.py:debug_section_similarity_distribution()` (lines 1751-1908)

### Expected Output
```json
{
  "sections_with_embeddings": 51,
  "cross_document_pairs": <number>,
  "distribution": {
    "min": <value>,
    "p50": <median>,
    "p90": <90th percentile>,
    "p95": <95th percentile>,
    "p99": <99th percentile>,
    "max": <max>
  },
  "thresholds_analysis": {
    "threshold_0.80": {"edges_created": 0, "percentage": 0.0},
    "threshold_0.75": {"edges_created": <count>, "percentage": <pct>},
    "threshold_0.70": {"edges_created": <count>, "percentage": <pct>}
  },
  "top_10_pairs": [...]
}
```

### Status
- Deployment in progress (revision 0000220)
- Import errors fixed: `Neo4jStore` → `Neo4jStoreV3` (commit 35fa4af)
- Initialization fixed: Added `uri`, `username`, `password` parameters
- Ready to call once deployment completes

---

## Next Steps (Priority Order)

### 1. Complete Debug Analysis
- [ ] Wait for deployment to complete (revision 0000220)
- [ ] Call debug endpoint to get similarity distribution
- [ ] Analyze distribution percentiles (p90, p95, p99)

### 2. Fix Threshold (If Needed)
**If p95 < 0.80:**
- [ ] Lower `similarity_threshold` to optimal value (likely 0.70-0.75)
- [ ] Update `lazygraphrag_pipeline.py` line 1383
- [ ] Redeploy and re-index

**If p95 ≥ 0.80:**
- [ ] Investigate logic bug in `_build_section_similarity_edges()`
- [ ] Check doc_id filtering and embedding linkage

### 3. Validate Edge Creation
- [ ] Re-index test group with new threshold
- [ ] Verify `semantic_similarity_edges > 0`
- [ ] Check edge distribution (should be ~5 per section)

### 4. Test Route 4 Deep Reasoning
- [ ] Run questions from `QUESTION_BANK_ROUTE4_DEEP_REASONING_2026.md`
- [ ] Validate confidence loop triggers
- [ ] Measure quality improvements vs HippoRAG 1

### 5. Benchmark Full Suite
- [ ] Run comprehensive benchmarks
- [ ] Compare against baseline (bench_baseline_quick.txt)
- [ ] Measure Route 3 (local search) improvements with new edges

---

## Critical Files Modified

### 1. `app/hybrid/indexing/lazygraphrag_pipeline.py`
**Lines 1293-1493:** Section embedding and similarity edge creation
- `_embed_section_nodes()`: ✅ Working
- `_build_section_similarity_edges()`: ❌ Needs investigation

**Key Parameters:**
```python
similarity_threshold = 0.80  # Line 1383 - May need adjustment
max_edges_per_section = 5    # Line 1384
```

### 2. `app/routers/hybrid.py`
**Lines 1751-1908:** Debug endpoint for similarity analysis
- Uses `Neo4jStoreV3` with credentials
- Computes cross-document pairwise cosine similarities
- Returns distribution and threshold analysis

**Lines 973-1150:** Route 4 confidence loop implementation
- Re-decomposes when `confidence < 0.5`
- Uses SEMANTICALLY_SIMILAR edges for context

### 3. `app/core/config.py`
No changes needed - using existing Neo4j credentials

---

## Infrastructure

### Azure Resources
- **Container App:** graphrag-orchestration (rg-graphrag-feature, swedencentral)
- **Neo4j:** neo4j-graphrag-23987.swedencentral.azurecontainer.io
- **ACR:** graphragacr12153.azurecr.io
- **Docker Image:** main-35fa4af-20260115145559 (pending deployment)

### Deployment Script
`deploy-graphrag.sh` - includes auto docker cleanup, builds/pushes image, updates Container App

---

## Key Commands

### Check Deployment Status
```bash
az containerapp revision list -n graphrag-orchestration -g rg-graphrag-feature \
  --query "[?properties.active].{name:name,trafficWeight:properties.trafficWeight,createdTime:properties.createdTime}" -o table
```

### Call Debug Endpoint
```bash
curl -s -H "X-Group-ID: test-5pdfs-1768486622652179443" \
  "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/debug/section_similarity_distribution" \
  | python3 -m json.tool
```

### Re-index Test Group
```bash
curl -X POST -H "X-Group-ID: test-5pdfs-1768486622652179443" \
  -H "Content-Type: application/json" \
  -d '{"document_ids": ["<list_of_5_doc_ids>"]}' \
  "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/index/reindex"
```

### Check Indexing Stats
```bash
curl -H "X-Group-ID: test-5pdfs-1768486622652179443" \
  "https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/hybrid/index/status"
```

---

## Decision Tree

```
Is deployment complete (revision 0000220 active)?
├─ NO  → Wait for deployment, monitor revision list
└─ YES → Call debug endpoint
         │
         Is p95 similarity < 0.80?
         ├─ YES (Parameter Issue)
         │   └─ Lower threshold to ~p75 (0.70-0.75)
         │      └─ Redeploy & re-index
         │         └─ Verify edges > 0
         │            └─ Test Route 4
         │
         └─ NO (Code Issue or Insufficient Data)
             └─ Check debug output:
                 - cross_document_pairs = 0? → Doc ID filtering bug
                 - pairs > 0 but no edges? → Logic bug in edge creation
                 - Investigate & fix
```

---

## Known Issues

### 1. Zero Edges Created
- **Impact:** HippoRAG 2 features disabled (no cross-doc connections)
- **Workaround:** Use Route 3 (local search) with standard edges
- **ETA:** Debug endpoint results pending

### 2. Deployment Latency
- **Symptom:** Revisions take ~4-6 minutes to become active
- **Mitigation:** Use `az containerapp revision list` to monitor
- **Not a blocker:** Expected behavior for Container Apps

---

## Testing Data

### Test Group Details
- **Group ID:** test-5pdfs-1768486622652179443
- **Documents:** 5 heterogeneous PDFs
- **Indexed Stats:**
  - 74 chunks
  - 401 entities
  - 828 relationships  
  - 51 sections with embeddings
  - 0 semantic_similarity_edges

### Benchmark Files
- `bench_baseline_quick.txt` - Pre-HippoRAG 2 baseline
- `bench_route4_*` - Route 4 deep reasoning tests (pending)
- `QUESTION_BANK_ROUTE4_DEEP_REASONING_2026.md` - Test questions

---

## References

### Architecture Documents
- `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md` - Full system design
- HippoRAG 2 weakness mitigations documented (Latent Transitions, Insufficient Depth)

### Git History
```
9511973 - Implement HippoRAG 2 features (SEMANTICALLY_SIMILAR edges + Confidence Loop)
082cfc0 - Add debug endpoint for section similarity distribution  
35fa4af - Fix Neo4jStoreV3 initialization in debug endpoint
```

---

## Contact & Continuity

**Current Blocking Issue:** Waiting for deployment revision 0000220 to become active
**Immediate Action Required:** Call debug endpoint once deployment completes
**Expected Resolution Time:** 5-10 minutes (deployment) + 5 minutes (analysis)

**Session Artifacts:**
- Terminal logs: `/tmp/deploy_*.log`
- Commit hash for rollback: `9511973` (last known good state)

---

**End of Handover**
