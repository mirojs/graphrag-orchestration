# Session Handover — 2026-02-15

**Last commit:** `f0fcb75f` on `main` (pushed)  
**Session focus:** PPR seed quality investigation — cross-group vector index bug, entity resolution experiments, document structure seed idea  

---

## What Was Completed Today

### 1. Cross-Group Vector Index Bug — Root Cause Found & Fixed ✅

**Problem:** `resolve_entities_semantic()` returned 0 results for many NER strings. Initially suspected missing embeddings.

**Root cause:** ALL 368 entities have `embedding_v2` (100% coverage). The real issue was the shared vector index `entity_embedding_v2` containing **1,807 entities across 9 groups** (40+ groups total with other entity labels). Our group `test-5pdfs-v2-fix2` was only 20% of the index. When querying `top_k=3`, other groups' entities filled all slots, and the `WHERE node.group_id = $group_id` post-filter wiped them out → 0 results.

**Evidence:**
- "Purchase Contract" → first our-group result at **rank 88** (out of 100)
- "Risk of Loss" → first our-group result at **rank 15**
- 6 of 6 test terms returned 0 results with `k=3` before fix

**Fix applied:** Dynamic label archiving — removed `:Entity` label from inactive groups, replaced with `:EntityArchived`. Vector index auto-scopes to `:Entity` label only.

```cypher
MATCH (e:Entity) WHERE e.group_id <> 'test-5pdfs-v2-fix2'
REMOVE e:Entity SET e:EntityArchived
```

- **6,594 entities archived** across 40 groups (preserved, fully reversible)
- **368 entities remain** in `:Entity` label (our group only)
- All 6 test terms now return results with `k=3` ✓

**Twist discovered:** The NER strings that returned 0 results ("Purchase Contract", "Risk of Loss", "Fees Clause", "Burst Pipe") **don't exist in our group at all** — they're hallucinated NER from decomposition. The group isolation bug accidentally gave the right answer for the wrong reason.

**Production impact:** This bug also affects production code:
- `async_neo4j_service.get_entities_by_vector_similarity()` — uses `top_k * 3 = 9`
- `hipporag_retriever.py` — uses `top_k * 2 = 6`
- DRIFT `vector_expansion_query` — uses raw `top_k`
- All insufficient when multiple groups share the index

### 2. Prior Experiment Results (Context from Recent Sessions)

| Experiment | Result | Status |
|---|---|---|
| Phase 3: Teleportation, EPIC, adaptive weights | All invalidated with real NER | ✅ Done |
| Phase 4: True matrix PPR | Identical coverage, 17x slower | ✅ Committed `f478e731`, reverted from production |
| Decomposition F vs G | G hurts: 1W/6T/3L, avg -0.006 | ✅ Done |
| Hallucination classification | 25 hall (38%), 41 transform (62%) | ✅ Done |
| Semantic resolution (Fs, Gs) | Fs +0.001, Gs +0.003 (modest) | ⚠️ Results invalid — ran before group isolation fix |

### 3. Semantic Resolution Experiment — NEEDS RE-RUN ⚠️

The `resolve_entities_semantic()` experiment (`experiment_decomposition_20260215T193023Z.json`) ran with the broken cross-group vector index. Now that the index is fixed, results should change significantly. The function at `scripts/experiment_decomposition.py` line ~293 is ready to re-run.

---

## What Is NOT Done — Todo List

### Immediate (Tomorrow Morning)

1. **Re-run decomposition experiment** — The 2×2 experiment (F/Fs/G/Gs) must be re-run with the fixed vector index. Previous Fs/Gs results are invalid.
   - File: `scripts/experiment_decomposition.py`
   - Command: `python scripts/experiment_decomposition.py`
   - Compare new results vs `experiment_decomposition_20260215T193023Z.json`

2. **Evaluate semantic resolution threshold** — With working vector search, the `sim_threshold=0.62` in `resolve_entities_semantic()` may need tuning. More entities will resolve now → threshold becomes the precision/recall tradeoff lever.

### Next Priority

3. **Document structure as seed source** — User's idea: use document structure embeddings (title, section titles) as additional PPR seeds and GPS signal. Currently NOT in the graph as embeddings. Need to:
   - Audit what structure data exists: `Section` nodes have `title` field, `Document` nodes have titles
   - Check if Section/Document nodes have `embedding_v2` 
   - Design: embed section titles with Voyage → use as additional seed candidates alongside NER entities
   - Hypothesis: section titles like "WARRANTY", "INSURANCE", "PAYMENT TERMS" are high-precision seeds that don't need NER

4. **Production oversampling fix** — Even with label archiving, production should handle multi-group indexes properly. Options:
   - Option A: Always archive inactive groups (current approach, fragile)
   - Option B: Increase oversampling to `max(top_k * 3, 100)` in production queries
   - Option C: Both

5. **Louvain community-based seed expansion** — User's earlier idea to use Louvain communities to expand seed set. Not yet investigated.

6. **Commit experiment results** — Scripts and JSON results from decomposition/PPR experiments are uncommitted.

---

## Key Files

| File | Purpose |
|---|---|
| `scripts/experiment_decomposition.py` | 2×2 experiment: {direct, decompose} × {old, semantic} resolution |
| `scripts/experiment_ppr_variants.py` | PPR variant comparison (A-E) with real LLM NER |
| `src/worker/services/async_neo4j_service.py` | Production PPR, vector search (line ~397, ~1401) |
| `src/worker/hybrid_v2/retrievers/hipporag_retriever.py` | Production HippoRAG vector search (line ~329) |

## Neo4j State

- **Group:** `test-5pdfs-v2-fix2` (368 Entity nodes, 12 Section nodes)
- **Vector index:** `entity_embedding_v2` — now contains only 368 entities (was 1,807)
- **Archived:** 6,594 `EntityArchived` nodes (reversible with `REMOVE e:EntityArchived SET e:Entity`)
- **URI:** `neo4j+s://a86dcf63.databases.neo4j.io`

## Key Insights Carried Forward

1. **Dehallucination is the #1 contribution** — confirmed by experiments. Sub-Q NER hallucinates 38% of entities.
2. **Entity embeddings are fine** — 100% coverage, Voyage 2048d from descriptions. No need for additional embedding types on entities.
3. **Document structure embeddings are missing** — Section titles and Document titles are NOT embedded. This is the user's next seed source idea.
4. **Cross-group isolation is a systemic issue** — affects all vector index queries in production. Label archiving is a tactical fix; production needs proper oversampling or per-group indexes.
