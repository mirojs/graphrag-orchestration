name: graphrag
metadata:
  template: graphrag@1.0

services:
  # API Gateway - handles HTTP requests, chat endpoints, folder management
  graphrag-api:
    project: .
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile.api
      context: .
      target: ""
    hooks:
      postdeploy:
        shell: sh
        run: |
          echo "API Gateway deployed successfully"
          # Prune dangling images
          docker image prune -f || true

  # Worker - processes background jobs from Redis queue
  graphrag-worker:
    project: .
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile.worker
      context: .
      target: ""
    hooks:
      postdeploy:
        shell: sh
        run: |
          echo "Worker deployed successfully"
          # Prune dangling images
          docker image prune -f || true

  # API Gateway B2C - External ID (consumer-facing) authentication
  graphrag-api-b2c:
    project: .
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile.api
      context: .
      target: ""
    hooks:
      postdeploy:
        shell: sh
        run: |
          echo "API B2C Gateway deployed successfully"
          # Prune dangling images
          docker image prune -f || true
