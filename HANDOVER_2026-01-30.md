# GraphRAG V2 Handover Document

**Date:** January 30, 2026  
**Status:** V2 Functional, API Detection Implemented, KNN Pending

---

## Current State Summary

### V2 Pipeline: ✅ Working

After fixing the missing `entity_embedding_v2` vector index, V2 is now functional and achieves **parity with V1** on the 11 ground-truth inconsistency detection test.

### Key Configuration

| Component | V1 | V2 |
|-----------|----|----|
| **Group ID** | `test-5pdfs-1769071711867955961` | `test-5pdfs-v2-enhanced-ex` |
| **Embedding Model** | OpenAI text-embedding-3-large | Voyage voyage-context-3 |
| **Embedding Dimensions** | 3072 | 2048 |
| **Vector Index** | `entity_embedding` | `entity_embedding_v2` |
| **KNN Enabled** | Yes | **No (disabled)** |

### Test Results

```
V1 vs V2 Comprehensive Test (5 questions)
─────────────────────────────────────────
Metric           │ V1 (OpenAI) │ V2 (Voyage)
─────────────────┼─────────────┼────────────
Average Score    │ 93.3%       │ 93.3%
Total Citations  │ 138         │ 144
Total Time       │ 252.3s      │ 241.0s

11 Ground-Truth Inconsistencies:
Both V1 and V2 achieve 100% on CONSISTENCY_DEEP question
```

---

## Commits Made Today

### 1. `b2c6bd8` - Fix V2 schema initialization
```
fix: initialize V2 schema (entity_embedding_v2 index) at app startup

- main.py now calls both V1 and V2 neo4j_store.initialize_schema()
- Ensures entity_embedding_v2 vector index is created for Voyage 2048-dim embeddings
- Root cause: V2 embeddings were stored but index was never created
```

### 2. `10878d0` - Auto-detect embedding version per group
```
fix: auto-detect embedding version (V1/V2) per group_id in API

- Added detect_embedding_version() to AsyncNeo4jService
- API now checks if group has embedding_v2 property to decide embedder
- V1 groups → OpenAI 3072D embeddings
- V2 groups → Voyage 2048D embeddings  
- Fixes dimension mismatch when VOYAGE_V2_ENABLED=true but querying V1 data
```

---

## Files Modified

| File | Change |
|------|--------|
| `app/main.py` | Added V2 schema initialization |
| `app/routers/hybrid.py` | Auto-detect embedding version per group_id |
| `app/services/async_neo4j_service.py` | Added `detect_embedding_version()` method |
| `app/hybrid_v2/pipeline/tracing.py` | Fixed logging reserved keyword (`error=`) |
| `app/hybrid/pipeline/tracing.py` | Fixed logging reserved keyword |
| `app/hybrid_v2/pipeline/intent.py` | Fixed logging reserved keyword |
| `app/hybrid/pipeline/intent.py` | Fixed logging reserved keyword |
| `scripts/test_v1_v2_comprehensive.py` | Fixed V1 group, changed to `voyage-context-3` |
| `ARCHITECTURE_PLAN_FULLSTACK_2026-01-30.md` | Added V2 config appendix |

---

## Outstanding TODO List

### High Priority

- [ ] **Enable KNN in V2 semantic beam search**
  - Currently disabled for V2
  - Check `tracing.py` for KNN configuration
  - Test impact on retrieval recall
  
- [ ] **Run API test with V2 group**
  - Test script uses direct pipeline instantiation
  - Need to verify API endpoint uses correct embedder detection
  - Endpoint: `POST /hybrid/query`
  
- [ ] **Verify 11 ground-truth from API call (not just test script)**
  - Test script bypasses some API logic
  - Need end-to-end API test

### Medium Priority

- [ ] **Update all test scripts to use `voyage-context-3`**
  - `test_11_ground_truth.py` still uses `voyage-3`
  - Search for `voyage-3` references and update
  
- [ ] **Cache embedding version detection**
  - Current: Queries Neo4j on every pipeline creation
  - Future: Cache result per group_id

- [ ] **Clean up benchmark files**
  - Many `comprehensive_test_*.json` files accumulated
  - Consider archiving or gitignoring

### Low Priority

- [ ] **Document V2 reindexing procedure**
  - How to create a new V2 group
  - Steps to verify embedding_v2 populated

- [ ] **Add V2-specific monitoring**
  - Track V2 vs V1 query latency
  - Track embedding dimension used per request

---

## Key Learnings

1. **Vector Index vs Vector Property**
   - Embeddings can be **stored** (property exists) but not **indexed** (no vector index)
   - Without index, `db.index.vector.queryNodes()` fails with "no such index"

2. **Voyage Model Names**
   - `voyage-3` and `voyage-3-large` require different API access
   - Use `voyage-context-3` for contextual embeddings (2048D)

3. **API vs Test Script Differences**
   - Test script: Directly instantiates pipeline with explicit `embedding_client`
   - API: Uses `VOYAGE_V2_ENABLED` flag and now auto-detection
   - Always verify with API call, not just test scripts

4. **structlog Reserved Parameters**
   - `error=`, `err=`, `error_msg=` may conflict with logger internals
   - Use `logger.exception()` for error logging with stack trace

---

## Quick Reference Commands

### Run V1 vs V2 Test
```bash
cd /afh/projects/graphrag-orchestration
python scripts/test_v1_v2_comprehensive.py
```

### Check Vector Indexes
```cypher
SHOW INDEXES WHERE type = 'VECTOR'
```

### Check Group Embedding Version
```cypher
MATCH (e:Entity {group_id: $group_id})
WHERE e.embedding_v2 IS NOT NULL
RETURN count(e) AS v2_count
LIMIT 1
```

### Clear Pipeline Cache (if needed)
Restart the API server to clear `_pipeline_cache`

---

## Environment Variables

```bash
# Required for V2
VOYAGE_API_KEY=xxx
VOYAGE_V2_ENABLED=true

# Model config (in app/core/config.py)
VOYAGE_MODEL_NAME=voyage-context-3
VOYAGE_EMBEDDING_DIM=2048
```

---

## Contact / Next Session

Continue with:
1. Enable KNN in V2 semantic beam
2. Run full API test (not just test script)
3. Verify all 11 ground-truth items via API response

---

*Handover document generated: January 30, 2026*
