# Check Upstream Updates - azure-search-openai-demo
#
# Runs weekly to check if the upstream frontend repository has updates.
# Creates an issue if updates are available so the team can review and sync.

name: Check Upstream Updates

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Create issue if updates found'
        required: false
        default: 'true'
        type: boolean

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for upstream updates
        id: check
        run: |
          UPSTREAM_REPO="https://github.com/Azure-Samples/azure-search-openai-demo.git"
          
          # Get latest upstream commit
          LATEST=$(git ls-remote "$UPSTREAM_REPO" HEAD | cut -f1)
          echo "latest_commit=${LATEST:0:12}" >> $GITHUB_OUTPUT
          echo "Latest upstream commit: ${LATEST:0:12}"
          
          # Read our tracked version
          if [[ -f "frontend/UPSTREAM_VERSION.md" ]]; then
            TRACKED=$(grep -oP 'Current Base:\s*\K[a-f0-9]+' frontend/UPSTREAM_VERSION.md | head -1 || echo "unknown")
            echo "tracked_commit=$TRACKED" >> $GITHUB_OUTPUT
            echo "Our tracked commit: $TRACKED"
          else
            echo "tracked_commit=unknown" >> $GITHUB_OUTPUT
            echo "::warning::UPSTREAM_VERSION.md not found"
          fi
          
          # Compare
          if [[ "$TRACKED" == "unknown" ]] || [[ "$TRACKED" != "${LATEST:0:12}" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "::notice::Upstream has new commits available"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "Frontend is up to date with upstream"
          fi
      
      - name: Get upstream changelog
        if: steps.check.outputs.has_updates == 'true'
        id: changelog
        run: |
          # Clone upstream to get recent commits
          git clone --depth 20 --single-branch https://github.com/Azure-Samples/azure-search-openai-demo.git /tmp/upstream
          
          cd /tmp/upstream
          RECENT_COMMITS=$(git log --oneline -10 | head -10)
          
          # Escape for GitHub output
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "recent_commits<<$EOF" >> $GITHUB_OUTPUT
          echo "$RECENT_COMMITS" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
      
      - name: Create or update issue
        if: steps.check.outputs.has_updates == 'true' && (github.event.inputs.create_issue != 'false')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”„ Upstream frontend updates available';
            const latestCommit = '${{ steps.check.outputs.latest_commit }}';
            const trackedCommit = '${{ steps.check.outputs.tracked_commit }}';
            const recentCommits = `${{ steps.changelog.outputs.recent_commits }}`;
            
            const body = `## Upstream Updates Available
            
            The [azure-search-openai-demo](https://github.com/Azure-Samples/azure-search-openai-demo) repository has new commits.
            
            | | Commit |
            |---|--------|
            | **Our tracked version** | \`${trackedCommit}\` |
            | **Latest upstream** | \`${latestCommit}\` |
            
            ### Recent Upstream Commits
            
            \`\`\`
            ${recentCommits}
            \`\`\`
            
            ### Action Required
            
            1. Review upstream changes: https://github.com/Azure-Samples/azure-search-openai-demo/commits/main
            2. Check for conflicts with our customizations (see \`frontend/UPSTREAM_VERSION.md\`)
            3. Run sync script: \`./scripts/sync_upstream.sh\`
            4. Test chat flow, settings panel, and error handling
            5. Update \`frontend/UPSTREAM_VERSION.md\` with new commit
            
            ### Customized Files to Check
            
            - \`app/backend/config.py\`
            - \`app/frontend/src/api/models.ts\`
            - \`app/frontend/src/components/Settings/\`
            - \`app/frontend/src/pages/chat/\`
            
            ---
            *This issue was automatically created by the upstream-check workflow.*
            `;
            
            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });
            
            const existingIssue = issues.find(i => i.title === title);
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync', 'frontend']
              });
              console.log('Created new upstream sync issue');
            }
      
      - name: Summary
        run: |
          echo "## Upstream Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Has Updates | ${{ steps.check.outputs.has_updates }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest Upstream | \`${{ steps.check.outputs.latest_commit }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Our Tracked | \`${{ steps.check.outputs.tracked_commit }}\` |" >> $GITHUB_STEP_SUMMARY
