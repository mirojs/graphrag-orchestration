# Handover Document â€” January 5, 2026 (Session 2)

## Session Summary

**Focus**: Implementing dual evaluation (Option 1 + Option 2) for Route 3 testing, discovered critical cross-document retrieval limitation.

## Work Completed

### 1. Dual Evaluation Implementation âœ…

Implemented both evaluation approaches as requested:

**Option 1**: Added theme coverage to `benchmark_route3_global_search.py`
- Added `EXPECTED_TERMS` dictionary for Q-G* questions (key terms that should appear)
- Added `calculate_theme_coverage()` function
- Updated console output and MD report to show theme coverage: `theme=75% (6/8)`
- Example output: `Q-G1: exact=0.80 min_sim=0.78 | acc: contain=0.85 f1=0.72 | theme=75% (6/8)`

**Option 2**: Updated `benchmark_route3_thematic.py` with 5PDF-specific questions
- Replaced 8 generic thematic questions (T-1 to T-8) with document-grounded queries
- Example: "Compare termination and cancellation provisions" instead of "What are common themes?"
- Added specific expected_themes for each question based on actual document content
- Updated cross-document questions (X-1, X-2) to be more specific

### 2. Entity Relevance Check Refinement âœ…

**Problem**: Graph-based negative detection was too aggressive, blocking legitimate global queries.

**Fix**: Relaxed entity relevance check in `orchestrator.py` (lines 1670-1740):
- Changed from "2-5 term queries only" to "weak graph signal only"
- Now only triggers if: `len(hub_entities) < 3 AND len(relationships) < 10 AND no term matches`
- **Result**: Q-G1 now returns content (was returning "Not found")

**Deployed**: January 5, 2026 @ 12:18 UTC

## Critical Issue Discovered ðŸš¨

### Cross-Document Retrieval Limitation

**Symptom**: All 3 Q-G* questions (Q-G1, Q-G2, Q-G3) only retrieve/cite `BUILDERS LIMITED WARRANTY.pdf`, missing other documents.

**Impact**:
- Q-G1 theme coverage: 12% (1/8 terms) - missing "60 days", "3 business days", "deposit", "forfeited" from other docs
- Q-G2 theme coverage: 50% (3/6 terms) - missing "florida", "hawaii", "pocatello" (non-WARRANTY docs)
- Q-G3 theme coverage: 12% (1/8 terms) - missing payment terms from invoice and property management agreement

**Validated Data Exists**:
```
Entities by document (Neo4j):
  BUILDERS LIMITED WARRANTY.pdf: 236 entities
  purchase_contract.pdf: 138 entities
  PROPERTY MANAGEMENT AGREEMENT.pdf: 78 entities
  HOLDING TANK SERVICING CONTRACT.pdf: 23 entities
  contoso_lifts_invoice.pdf: 16 entities
```

**Entities Confirmed Present**:
- Termination: "cancel within 3 business days", "60 days", "written notice"
- Payments: "fee/commission of 25% of gross revenues", "Payment in 3 installments", "$29900"

**Root Cause**: Community matching fallback logic in `community_matcher.py` lines 280-320:

```python
# When keywords don't match entities, falls back to TOP ENTITIES BY DEGREE
fallback_query = """
    MATCH (e:Entity)
    WHERE e.group_id = $group_id
    RETURN e.name AS name, e.description AS description
    ORDER BY coalesce(e.degree, 0) DESC  # <-- Problem: WARRANTY has most entities (236) â†’ highest degree
    LIMIT 10
"""
```

Since WARRANTY document has 236 entities (vs 138, 78, 23, 16 for others), its entities naturally have higher degree due to more intra-document relationships.

### Reproduction Steps

```bash
export TEST_GROUP_ID="test-5pdfs-1767429340223041632"
python3 scripts/benchmark_route3_global_search.py --repeats 1 --max-questions 3

# Results:
# Q-G1: theme=12% (1/8) - only WARRANTY cited
# Q-G2: theme=50% (3/6) - only WARRANTY cited
# Q-G3: theme=12% (1/8) - only WARRANTY cited
```

## Recommended Fix

### Strategy: Embedding-Based Community Matching

Replace degree-based fallback with embedding similarity:

```python
# Current (degree-based fallback):
fallback_query = """
    MATCH (e:Entity)
    WHERE e.group_id = $group_id
    RETURN e.name AS name, e.description AS description
    ORDER BY coalesce(e.degree, 0) DESC  # Biased toward largest document
    LIMIT 10
"""

# Proposed (embedding-based):
async def _generate_communities_from_query(self, query: str, top_k: int):
    # 1. Get query embedding
    query_embedding = await self._get_embedding(query)
    
    # 2. Find entities by embedding similarity (not keyword match)
    search_query = """
        MATCH (e:Entity)
        WHERE e.group_id = $group_id AND e.embedding IS NOT NULL
        WITH e, vector.similarity.cosine(e.embedding, $query_embedding) AS sim
        WHERE sim > 0.5  # Minimum relevance threshold
        RETURN e.name AS name, sim
        ORDER BY sim DESC
        LIMIT 20
    """
    # 3. Group by source document to ensure multi-document coverage
    # 4. Return top entities from EACH document (not just highest degree overall)
```

### Alternative: Multi-Document Sampling

Ensure fallback retrieves entities from **all documents**, not just highest-degree:

```python
# Get top 2-3 entities from EACH document
fallback_query = """
    MATCH (c:TextChunk)-[:MENTIONS]->(e:Entity)
    WHERE c.group_id = $group_id
    WITH c, e, apoc.convert.fromJsonMap(c.metadata) AS meta
    WITH meta.url AS doc_url, e
    ORDER BY coalesce(e.degree, 0) DESC
    RETURN doc_url, collect(DISTINCT e.name)[..2] AS entities  # Top 2 per doc
"""
```

## Files Modified

1. **`scripts/benchmark_route3_global_search.py`**
   - Added `EXPECTED_TERMS` dictionary (lines 45-57)
   - Added `calculate_theme_coverage()` function (lines 59-87)
   - Updated results collection to include theme_coverage (lines 430-445)
   - Updated console output with theme string (lines 450-470)
   - Updated MD report with theme_info (lines 510-540)

2. **`scripts/benchmark_route3_thematic.py`**
   - Replaced `THEMATIC_QUESTIONS` with 5PDF-specific questions (lines 42-90)
   - Updated `CROSS_DOC_QUESTIONS` with document-grounded queries (lines 92-106)

3. **`graphrag-orchestration/app/hybrid/orchestrator.py`**
   - Modified entity relevance check logic (lines 1670-1740)
   - Changed condition from `2 <= len(query_terms) <= 5` to `has_strong_graph_signal` check
   - Deployed to Azure Container Apps

## Next Steps

1. **Fix cross-document retrieval** in `community_matcher.py`:
   - Option A: Implement embedding-based entity matching (preferred)
   - Option B: Multi-document sampling fallback
   - Target file: `graphrag-orchestration/app/hybrid/pipeline/community_matcher.py` lines 280-320

2. **Re-run benchmarks** after fix:
   ```bash
   python3 scripts/benchmark_route3_global_search.py --repeats 1 --max-questions 10
   python3 scripts/benchmark_route3_thematic.py --repeats 1
   ```

3. **Expected improvements**:
   - Q-G1 theme coverage: 12% â†’ 75%+ (should find terms from all 5 docs)
   - Q-G2 theme coverage: 50% â†’ 83%+ (should cite florida/hawaii/pocatello)
   - Q-G3 theme coverage: 12% â†’ 75%+ (should find payment terms from all docs)

4. **Commit and document**:
   - Create handover for community matcher fix
   - Update architecture docs with cross-document retrieval strategy
   - Run full 20-question benchmark suite

## Test Environment

- **Azure Container App**: graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io
- **Test Group ID**: `test-5pdfs-1767429340223041632`
- **Neo4j**: a86dcf63.databases.neo4j.io
- **Documents**: 5 PDFs (WARRANTY, purchase_contract, property_management, holding_tank, invoice)
- **Entities**: 474 total (verified in Neo4j)
- **Chunks**: 79 total

## Benchmark Results (Before Cross-Doc Fix)

### Global Search (Q-G*)
```
Q-G1: exact=1.00 min_sim=1.00 p50=18243ms | acc: contain=0.29 f1=0.09 | theme=12% (1/8)
Q-G2: exact=1.00 min_sim=1.00 p50=41479ms | acc: contain=0.57 f1=0.10 | theme=50% (3/6)  
Q-G3: exact=1.00 min_sim=1.00 p50=14932ms | acc: contain=0.12 f1=0.04 | theme=12% (1/8)
```

**Issue**: Only WARRANTY.pdf cited, missing other 4 documents.

## Architecture Documentation

- **File**: `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md`
- **Section 3.7**: Dual Evaluation Approach already documented
- **No updates needed** - documentation matches implementation

## Git Status

- **Not committed yet**: `orchestrator.py` entity relevance check fix
- **Not committed yet**: Benchmark script updates (Option 1 + Option 2)
- **Reason**: Waiting to fix cross-document retrieval first, then commit all changes together

## Key Insights

1. **Negative detection relaxation worked** - Q-G1 no longer returns "Not found"
2. **Cross-document retrieval is the bottleneck** - community matching favors largest document
3. **Data quality is good** - all entities exist in Neo4j, distribution is reasonable
4. **Embedding-based matching is needed** - keyword matching too brittle for abstract global queries
5. **Dual evaluation reveals issues** - theme coverage metric exposed the single-document bias

---

**Handover Date**: January 5, 2026  
**Session Duration**: ~2 hours  
**Priority**: Fix cross-document retrieval (high impact, clear solution)  
**Status**: Investigation complete, fix strategy identified, ready for implementation
