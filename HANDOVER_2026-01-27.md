# Handover Document: Knowledge Map API Project

**Date:** January 27, 2026  
**Session:** Knowledge Map API Design & Documentation  
**Status:** Ready for Implementation

---

## Summary of Today's Session

We designed and documented a **Knowledge Map Document Processing API** as a drop-in replacement for Azure Content Understanding. The API provides async batch document processing with a polling pattern, built on top of Azure Document Intelligence.

---

## What Was Completed Today

### ✅ Code Implementation (Merged to Main)

| Item | Status | Files |
|------|--------|-------|
| Knowledge Map async API router | ✅ Merged | `app/routers/knowledge_map.py` |
| SimpleDocumentAnalysisService | ✅ Merged | `app/services/simple_document_analysis_service.py` |
| Sync document analysis API | ✅ Merged | `app/routers/document_analysis.py` |
| Router registration in main.py | ✅ Merged | `app/main.py` |
| Type error fixes | ✅ Merged | Multiple files |

**Git commits on main:**
- `ea1ff19` - Fix DI service call - use extract_documents
- `2d3d18c` - Add Knowledge Map API documentation

### ✅ Documentation Created

| Document | Purpose | Location |
|----------|---------|----------|
| API Guide | Developer integration guide with examples | `docs/KNOWLEDGE_MAP_API_GUIDE.md` |
| Deployment Plan | Container Apps + Redis architecture | `docs/KNOWLEDGE_MAP_API_DEPLOYMENT_PLAN_2026-01-27.md` |
| Architecture Update | Design rationale in main arch doc | `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md` (Section 6.1) |

### ✅ Testing Completed

| Test | Result | Notes |
|------|--------|-------|
| API with Azure DI Sweden Central | ❌ Failed | InternalServerError from Azure |
| API with Azure DI West US | ✅ Passed | 64-page PDF extracted successfully |
| POST /process endpoint | ✅ Passed | Returns operation_id |
| GET /operations/{id} polling | ✅ Passed | Status transitions work |
| TTL expiry (60s) | ✅ Passed | Operation expires after completion |

### ✅ Architecture Decision Made

**Selected:** Container Apps + Redis + Easy Auth

**Rationale:**
- ~$50-65/month total cost (vs $175+ for Functions Premium)
- No APIM complexity for Day 1
- FastAPI code runs unchanged
- Redis provides production-ready state persistence

---

## Current State of the Codebase

### API Endpoints Available

```
POST /api/v1/knowledge-map/process          # Submit batch (async)
GET  /api/v1/knowledge-map/operations/{id}  # Poll status
DELETE /api/v1/knowledge-map/operations/{id} # Delete operation

POST /api/v1/document-analysis/analyze      # Sync batch analysis
POST /api/v1/document-analysis/analyze-single # Sync single doc
GET  /api/v1/document-analysis/backend-info # Backend diagnostics
```

### Known Limitation (Blocking Production)

**In-memory operation store** — Current implementation stores operations in a Python dict. This won't survive:
- Container restarts
- Multiple replicas (each has own dict)
- Scale-to-zero scenarios

**Solution documented in deployment plan:** Add Redis-backed `OperationStore`

### Environment Variables Required

```bash
# Document Intelligence (Working - West US)
AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT=https://westus.api.cognitive.microsoft.com/
AZURE_DOCUMENT_INTELLIGENCE_KEY=<key>

# Redis (TODO - not yet implemented)
REDIS_URL=redis://localhost:6379  # or Azure Redis connection string

# Optional
KNOWLEDGE_MAP_AUTH_ENABLED=false
```

---

## TODO List for Tomorrow

### Priority 1: Redis Operation Store (Blocker for Deployment)

- [ ] Create `app/services/operation_store.py` — Abstract base class
- [ ] Create `app/services/redis_operation_store.py` — Redis implementation
- [ ] Create `app/services/memory_operation_store.py` — Keep for local dev
- [ ] Add factory function `get_operation_store()` with auto-detection
- [ ] Update `app/routers/knowledge_map.py` to use store interface
- [ ] Add `redis>=5.0.0` to requirements.txt
- [ ] Test locally with Docker Redis

### Priority 2: Containerization

- [ ] Create `Dockerfile` for production
- [ ] Create `.dockerignore`
- [ ] Test build locally: `docker build -t knowledge-map-api:local .`
- [ ] Test run with Docker Redis

### Priority 3: Azure Deployment

- [ ] Create Azure Redis Cache (Basic C0, ~$15/mo)
- [ ] Create Azure Container Registry
- [ ] Push Docker image to ACR
- [ ] Create Container Apps Environment
- [ ] Deploy Container App with secrets
- [ ] Enable Easy Auth (optional)
- [ ] Verify health endpoint
- [ ] Run end-to-end test

### Priority 4: Cleanup & Polish

- [ ] Commit and push Redis store implementation
- [ ] Update API guide with Redis configuration
- [ ] Add deployment instructions to README (optional)

---

## Files to Reference Tomorrow

| File | Why |
|------|-----|
| `docs/KNOWLEDGE_MAP_API_DEPLOYMENT_PLAN_2026-01-27.md` | Full implementation code snippets |
| `docs/KNOWLEDGE_MAP_API_GUIDE.md` | API contract documentation |
| `app/routers/knowledge_map.py` | Current implementation to modify |
| `ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md` Section 6.1 | Design rationale |

---

## Quick Start Commands for Tomorrow

```bash
# 1. Start local dev server
cd /afh/projects/graphrag-orchestration
source .venv/bin/activate  # or your env
uvicorn app.main:app --reload --port 8000

# 2. Start local Redis for testing
docker run -d --name redis -p 6379:6379 redis:7-alpine

# 3. Test API
curl -X POST http://localhost:8000/api/v1/knowledge-map/process \
    -H "Content-Type: application/json" \
    -d '{"inputs": [{"source": "https://your-blob-url/test.pdf"}]}'

# 4. Check git status
git status
git log --oneline -5
```

---

## Key Decisions Made

1. **Batch-first API** — No single-document endpoint, always `inputs[]` array
2. **Fail-fast errors** — Any document failure stops entire batch (no partial results)
3. **60-second TTL** — Operations expire 60s after terminal state
4. **Redis over Cosmos** — Simpler, cheaper for ephemeral operation state
5. **No APIM on Day 1** — Use Container Apps Easy Auth until external clients need rate limiting
6. **West US region** — Azure DI Sweden Central had issues, West US confirmed working

---

## Contact / Context

This is a continuation of the Knowledge Map API implementation that started with PR #1 from the cloud agent, which was then enhanced with the async polling pattern.

The API is designed to replace Azure Content Understanding for document processing in the GraphRAG orchestration pipeline.

---

**End of Handover Document**
