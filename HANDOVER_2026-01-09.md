# GraphRAG Orchestration - Handover (January 9, 2026)

**Date:** January 9, 2026

**Status:** Route 3 negative handling improved, but production has a known 500 regression pending deploy.

---

## What Changed Today (High Level)

### 1) Route 3 negative questions: deterministic pre-synthesis gate

**Goal:** Make Route 3 negative answers strictly “not found / not specified” with no extra helpful content (to satisfy the benchmark evaluator).

**Approach:** Added a deterministic, pre-synthesis evidence scan for common “missing-field” negative prompts (routing number, IBAN, SWIFT/BIC, VAT/Tax ID, portal URL, shipment method, governing law, etc.). If the requested field/value is not present in retrieved evidence text, the orchestrator returns a refusal-only response.

**Bounded cost:** Scan is capped by an env var (`ROUTE3_NEGATIVE_SCAN_CHUNKS`).

**Why this worked:** Retrieval often finds related payment/shipping text even when the specific field is missing; the gate prevents the model from adding tangentially relevant details that cause negative-eval FAIL.

### 2) Architecture documentation update

Updated the architecture doc to explicitly describe:
- Neo4j fulltext BM25 merging for Route 3 positive questions.
- Section-node retrieval/expansion via `(:TextChunk)-[:IN_SECTION]->(:Section)` for positive questions.
- The new deterministic negative-question solution.

File: [ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md](ARCHITECTURE_DESIGN_LAZY_HIPPO_HYBRID.md)

---

## Current Production State (Important)

### Known issue: HTTP 500 on some invoice-related negatives

**Symptom:** Some Q-N* requests return HTTP 500 (empty response) rather than a refusal.

**Root cause (from container logs):** A leftover code path referenced an undefined variable `has_graph_signal`.

**Fix status:**
- A fix was implemented and pushed (defines `has_graph_signal` and hardens related logging/null-safety).
- Deployment of that fix was started but cancelled, so production is still on the revision that can 500.

**Impact:** Negative benchmark looked strong for most questions, but the remaining failures were infra-level 500s (not evaluator mismatches).

---

## Bench / Dataset Context

- **Tenant / Group ID:** `test-5pdfs-1767429340223041632`
- **Document set (5 PDFs):** invoice + purchase contract + builders warranty + property management agreement + holding tank servicing contract
- **Known positive gap:** Q-G10 “one sentence per document” does not reliably retrieve the invoice without per-document forcing; doc-lead forcing remains disabled by default for scalability.

---

## Where to Look (Code)

- Orchestration + negative gate: [graphrag-orchestration/app/hybrid/orchestrator.py](graphrag-orchestration/app/hybrid/orchestrator.py)
- Retrieval stack (graph/section expansion): [graphrag-orchestration/app/hybrid/pipeline/enhanced_graph_retriever.py](graphrag-orchestration/app/hybrid/pipeline/enhanced_graph_retriever.py)
- Synthesis prompt strictness: [graphrag-orchestration/app/hybrid/pipeline/synthesis.py](graphrag-orchestration/app/hybrid/pipeline/synthesis.py)

---

## TODO (Continue Tomorrow)

### P0 — Stop the 500s (deploy the fix)
- Deploy the latest `main` (contains the `has_graph_signal` fix).
- Re-run Route 3 benchmark and confirm Q-N4 / Q-N10 no longer error.

### P1 — Re-validate negatives end-to-end
- Run `scripts/benchmark_route3_global_search.py` against the deployed URL with group id `test-5pdfs-1767429340223041632`.
- Target: 10/10 negatives PASS and no “helpful” add-on content.

### P2 — Confirm positives weren’t regressed
- Spot-check a few Q-G* questions after the deploy.
- Verify BM25 + section-node expansion still behaves as expected.

### P3 — Optional follow-up: Q-G10 invoice coverage (scalable approaches only)
- If we still care about Q-G10, consider query decomposition or lightweight “per-doc mention” strategy that doesn’t force per-document lead chunks (doc-lead is intentionally disabled by default).

---

## Notes / Feature Flags

- `ROUTE3_DOC_LEAD_BOOST=0` (kept disabled by default for scalability)
- `ROUTE3_NEGATIVE_SCAN_CHUNKS` (caps evidence scanned for deterministic negative gate)
- `SECTION_GRAPH_ENABLED` (section-node expansion)
- `ROUTE3_FULLTEXT_BOOST` (BM25 candidate injection/merge)
