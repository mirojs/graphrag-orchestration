# Status Snapshot — GraphRAG Orchestration / DRIFT V3
**Date:** 2025-12-28

## Production target
- **Base URL:** https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io
- **Primary endpoint:** `POST /graphrag/v3/query/drift`
- **Tenant (group):** `drift-ok-1766862426` (via `X-Group-ID` header)
- **ACA revision mode:** Single (latest revision receives 100% traffic)

## What was broken (starting point)
- DRIFT V3 returned HTTP 200 answers but `sources=0` on Azure Container Apps.
- In ACA logs, `SearchResult.context_data == {}` meant no extractable citations.
- Later, even with sources present, answers often said “Not specified…” despite evidence being in the corpus.
- ACA log streaming appeared “stuck”; logs showed extreme prompt sizes (e.g., `prompt_len ~ 1.1M`) and repeated token-limit thrash.

## Current state (as of end of day)
### ✅ Sources/citations in production
- Implemented `DRIFTSearchWithCandidates` so that when `include_sources=true`, DRIFT local search uses `return_candidate_context=True`.
- Result: `sources` are now returned in production for DRIFT responses.

### ✅ Tenant-safe retrieval is stable
- Neo4j vector retrieval: **oversample → tenant filter by `group_id` → limit**.
- Fixed vector index name mismatch (`entity` → `entity_embedding`).
- Added adaptive retry (increase `fetch_k` once) when tenant hits are 0.
- Added in-memory cosine fallback using cached entity embeddings for resilience.

### ✅ Indexing no longer suffers from stale in-process caches
- `/graphrag/v3/index` clears DRIFT caches at indexing start for the group.
- Reindexed all 5 PDFs into `drift-ok-1766862426`.

### ✅ DRIFT is “real DRIFT” (not post-answer fallback)
- No post-answer “answer-from-sources” fallback is used.
- Key integration fix: DRIFT LLM wrapper now actually forwards GraphRAG `history` (system/context messages) into LLM calls.

### ✅ “Log stream stuck” / prompt bloat mitigated
- Added history/prompt guardrails in the DRIFT LLM wrapper:
  - Per-message and total history truncation.
  - Centralized prompt building.
  - Best-effort pass-through of GraphRAG `model_parameters` to underlying LLM calls.
  - Fixed async streaming call pattern.
- Added config/env settings:
  - `V3_DRIFT_MAX_HISTORY_CHARS` (default `120000`)
  - `V3_DRIFT_MAX_HISTORY_MESSAGE_CHARS` (default `40000`)
- Added debug log when truncation occurs (behind `V3_DRIFT_DEBUG_LOGGING`).

### ✅ Answer quality improvement for Q-D1
- Tweaked prompt prefix instructions to avoid false “Not specified…” when partial evidence exists.

## Deployment notes
- Latest image deployed to ACA from this repo via `./deploy-graphrag.sh`.
- After deploying the prefix tweak, DRIFT question subset runs completed successfully.
- Set ACA env vars for tunable history caps (created a new revision):
  - `V3_DRIFT_MAX_HISTORY_CHARS=120000`
  - `V3_DRIFT_MAX_HISTORY_MESSAGE_CHARS=40000`

## Validation performed today
### Question bank subset (Q-D1..Q-D3)
Ran: `scripts/run_drift_question_bank_subset.py` against prod.

- Q-D1/Q-D2/Q-D3 all returned HTTP 200 with sources.
- After the prefix tweak + latest revision(s), Q-D1 answer is consistently grounded.

### Q-D1 repeatability check
- Ran Q-D1 **10 times** back-to-back against prod.
- Result: **10/10 HTTP 200**, **0/10 “Not specified…”**, sources consistently present (range observed: **8–22**).

### Spot-check correctness (Q-D1)
Q-D1 asks: “If an emergency defect occurs under the warranty (e.g., burst pipe), what is the required notification channel and consequence of delay?”

- Answer correctly cites:
  - Emergency reports can be taken by phone (“Only emergency reports will be taken by phone; otherwise, written notice is required.”)
  - Written notice procedure (“write a letter… certified mail return receipt requested”)
  - Consequence of delay: claims not made in writing within the warranty period are not covered.

## Known remaining issues / improvements (tomorrow)
- **Source list quality/noise:** some top sources are occasionally irrelevant snippets; consider tightening source selection/ranking to reduce noise (without changing the response schema/UX).
- **Rate limit / burstiness:** prompt bloat was the dominant “stuck” cause; if 429s reappear, consider reducing DRIFT concurrency/depth or adding throttling.
- **Operational visibility:** verify `[DRIFT_DEBUG] history truncated...` appears when caps hit (enable `V3_DRIFT_DEBUG_LOGGING` temporarily for a single group if needed).

## Handy commands
- Health: `curl https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io/health`
- DRIFT subset runner:
  - `python scripts/run_drift_question_bank_subset.py --base-url https://graphrag-orchestration.salmonhill-df6033f3.swedencentral.azurecontainerapps.io --group-id drift-ok-1766862426 --timeout-sec 220 --include-sources --max-iterations 1`
- ACA logs:
  - `az containerapp logs show -n graphrag-orchestration -g rg-graphrag-feature --follow`
